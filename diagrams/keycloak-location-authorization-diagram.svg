<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 1700" style="background-color: #ffffff;">
  <!-- Title -->
  <text x="700" y="30" font-family="Arial, sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    Keycloak Location-Based Authorization Using County Groups
  </text>
  <text x="700" y="55" font-family="Arial, sans-serif" font-size="14" text-anchor="middle" fill="#6b7280">
    Users Can Belong to One or Multiple County Groups - JWT Contains All Counties User Can Access
  </text>

  <!-- Keycloak Realm -->
  <rect x="50" y="80" width="1300" height="1580" rx="10" fill="#f0f4f8" stroke="#1e3a8a" stroke-width="2"/>
  <text x="700" y="105" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    Keycloak Realm: CMIPS
  </text>

  <!-- Users Section -->
  <rect x="100" y="140" width="600" height="280" rx="5" fill="#e8f4f8" stroke="#1e3a8a" stroke-width="2"/>
  <text x="400" y="165" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    Users (Can Belong to One or Multiple County Groups)
  </text>

  <!-- User 1 - Single County -->
  <rect x="120" y="190" width="170" height="100" rx="5" fill="#ffffff" stroke="#2563eb" stroke-width="2"/>
  <text x="205" y="210" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    User: john.doe
  </text>
  <text x="205" y="230" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#9333ea">
    Role: CASE_WORKER
  </text>
  <text x="205" y="250" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#059669">
    County Groups: [County A]
  </text>
  <text x="205" y="270" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b7280">
    Can access: County A data
  </text>
  <text x="205" y="285" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#dc2626">
    Cannot access: Other counties
  </text>

  <!-- User 2 - Multiple Counties -->
  <rect x="310" y="190" width="170" height="100" rx="5" fill="#ffffff" stroke="#2563eb" stroke-width="2"/>
  <text x="395" y="210" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    User: jane.smith
  </text>
  <text x="395" y="230" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#9333ea">
    Role: SUPERVISOR
  </text>
  <text x="395" y="250" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#059669">
    County Groups: [County B, County C]
  </text>
  <text x="395" y="270" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">
    Can access: County B &amp; C data
  </text>
  <text x="395" y="285" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#dc2626">
    Cannot access: Other counties
  </text>

  <!-- User 3 - Multiple Counties -->
  <rect x="500" y="190" width="170" height="100" rx="5" fill="#ffffff" stroke="#2563eb" stroke-width="2"/>
  <text x="585" y="210" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    User: mike.jones
  </text>
  <text x="585" y="230" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#9333ea">
    Role: CASE_WORKER
  </text>
  <text x="585" y="250" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#059669">
    County Groups: [County A, County D, County 25]
  </text>
  <text x="585" y="270" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">
    Can access: 3 counties data
  </text>
  <text x="585" y="285" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#dc2626">
    Cannot access: Other counties
  </text>

  <!-- User 4 - Admin (All Counties) -->
  <rect x="690" y="190" width="170" height="100" rx="5" fill="#ffffff" stroke="#dc2626" stroke-width="2"/>
  <text x="775" y="210" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    User: admin
  </text>
  <text x="775" y="230" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#9333ea">
    Role: ADMIN
  </text>
  <text x="775" y="250" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#dc2626">
    County Groups: [ALL]
  </text>
  <text x="775" y="270" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">
    Can access: All 58 counties
  </text>
  <text x="775" y="285" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">
    Special admin access
  </text>

  <!-- County Groups Section -->
  <rect x="100" y="460" width="1200" height="320" rx="5" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
  <text x="700" y="485" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">
    58 County Groups - Define Which Counties User Can Access
  </text>
  <text x="700" y="505" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="#92400e">
    Users Can Belong to One or Multiple County Groups
  </text>

  <!-- County A Group -->
  <rect x="130" y="530" width="200" height="120" rx="5" fill="#ffffff" stroke="#f59e0b" stroke-width="2"/>
  <text x="230" y="555" font-family="Arial, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">
    County A Group
  </text>
  <text x="230" y="575" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    Purpose: Access County A Data
  </text>
  <rect x="150" y="585" width="160" height="20" rx="3" fill="#fef3c7"/>
  <text x="230" y="598" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#92400e">Location: County A</text>
  <rect x="150" y="610" width="160" height="20" rx="3" fill="#fef3c7"/>
  <text x="230" y="623" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#92400e">Users: john.doe, mike.jones</text>
  <rect x="150" y="635" width="160" height="10" rx="3" fill="#fee2e2"/>
  <text x="230" y="642" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#dc2626">No role information</text>

  <!-- County B Group -->
  <rect x="360" y="530" width="200" height="120" rx="5" fill="#ffffff" stroke="#f59e0b" stroke-width="2"/>
  <text x="460" y="555" font-family="Arial, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">
    County B Group
  </text>
  <text x="460" y="575" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    Purpose: Access County B Data
  </text>
  <rect x="380" y="585" width="160" height="20" rx="3" fill="#fef3c7"/>
  <text x="460" y="598" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#92400e">Location: County B</text>
  <rect x="380" y="610" width="160" height="20" rx="3" fill="#fef3c7"/>
  <text x="460" y="623" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#92400e">Users: jane.smith</text>
  <rect x="380" y="635" width="160" height="10" rx="3" fill="#fee2e2"/>
  <text x="460" y="642" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#dc2626">No role information</text>

  <!-- County C Group -->
  <rect x="590" y="530" width="200" height="120" rx="5" fill="#ffffff" stroke="#f59e0b" stroke-width="2"/>
  <text x="690" y="555" font-family="Arial, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">
    County C Group
  </text>
  <text x="690" y="575" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    Purpose: Access County C Data
  </text>
  <rect x="610" y="585" width="160" height="20" rx="3" fill="#fef3c7"/>
  <text x="690" y="598" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#92400e">Location: County C</text>
  <rect x="610" y="610" width="160" height="20" rx="3" fill="#fef3c7"/>
  <text x="690" y="623" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#92400e">Users: jane.smith</text>
  <rect x="610" y="635" width="160" height="10" rx="3" fill="#fee2e2"/>
  <text x="690" y="642" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#dc2626">No role information</text>

  <!-- County D Group -->
  <rect x="820" y="530" width="200" height="120" rx="5" fill="#ffffff" stroke="#f59e0b" stroke-width="2" stroke-dasharray="5,5"/>
  <text x="920" y="555" font-family="Arial, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">
    County D Group
  </text>
  <text x="920" y="575" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    Purpose: Access County D Data
  </text>
  <rect x="840" y="585" width="160" height="20" rx="3" fill="#fef3c7"/>
  <text x="920" y="598" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#92400e">Location: County D</text>
  <rect x="840" y="610" width="160" height="20" rx="3" fill="#fef3c7"/>
  <text x="920" y="623" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#92400e">Users: mike.jones</text>
  <rect x="840" y="635" width="160" height="10" rx="3" fill="#fee2e2"/>
  <text x="920" y="642" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#dc2626">No role information</text>

  <!-- More Counties Indicator -->
  <rect x="1050" y="530" width="220" height="120" rx="5" fill="#f3f4f6" stroke="#9ca3af" stroke-width="2" stroke-dasharray="3,3"/>
  <text x="1160" y="560" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#6b7280">
    ... and 54 more
  </text>
  <text x="1160" y="585" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#6b7280">
    County Groups
  </text>
  <text x="1160" y="610" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    (County E through
  </text>
  <text x="1160" y="630" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    County 58)
  </text>
  <text x="1160" y="645" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b7280">
    Each defines data access
  </text>

  <!-- Key Concept Box -->
  <rect x="130" y="680" width="1140" height="80" rx="5" fill="#dbeafe" stroke="#2563eb" stroke-width="2"/>
  <text x="700" y="705" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#1e40af">
    Key Concept: County Groups = Data Access Scope
  </text>
  <text x="150" y="730" font-family="Arial, sans-serif" font-size="11" fill="#1e40af">
    • County groups define WHICH counties' data a user can access
  </text>
  <text x="600" y="730" font-family="Arial, sans-serif" font-size="11" fill="#1e40af">
    • A user can belong to ONE county group OR MULTIPLE county groups
  </text>
  <text x="150" y="750" font-family="Arial, sans-serif" font-size="11" fill="#1e40af">
    • JWT token contains ALL county groups the user belongs to: [County A, County B, County C]
  </text>
  <text x="600" y="750" font-family="Arial, sans-serif" font-size="11" fill="#1e40af">
    • User can access data for ALL counties listed in their JWT token groups
  </text>

  <!-- Arrows from Users to County Groups (Multiple) -->
  <path d="M 205 290 L 230 530" stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 585 290 L 230 530" stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 395 290 L 460 530" stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 395 290 L 690 530" stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 585 290 L 920 530" stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="230" y="420" font-family="Arial, sans-serif" font-size="10" fill="#3b82f6">Belongs to</text>
  <text x="460" y="420" font-family="Arial, sans-serif" font-size="10" fill="#3b82f6">Belongs to</text>
  <text x="690" y="420" font-family="Arial, sans-serif" font-size="10" fill="#3b82f6">Belongs to</text>
  <text x="920" y="420" font-family="Arial, sans-serif" font-size="10" fill="#3b82f6">Belongs to</text>
  <text x="500" y="420" font-family="Arial, sans-serif" font-size="10" fill="#3b82f6">Belongs to</text>
  <text x="350" y="420" font-family="Arial, sans-serif" font-size="10" fill="#3b82f6">Belongs to</text>

  <!-- JWT Token Section -->
  <rect x="100" y="800" width="1200" height="200" rx="5" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
  <text x="700" y="825" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#166534">
    JWT Token Contains All County Groups User Belongs To
  </text>

  <!-- JWT for User 1 (Single County) -->
  <rect x="130" y="850" width="280" height="130" rx="5" fill="#ffffff" stroke="#16a34a" stroke-width="2"/>
  <text x="270" y="875" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#166534">
    john.doe JWT Token
  </text>
  <rect x="150" y="885" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="270" y="898" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#166534">Groups: ["County A"]</text>
  <rect x="150" y="910" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="270" y="923" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#166534">Roles: ["CASE_WORKER"]</text>
  <rect x="150" y="935" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="270" y="948" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#166534">Can Access: County A data only</text>
  <rect x="150" y="960" width="240" height="15" rx="3" fill="#fee2e2"/>
  <text x="270" y="970" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#dc2626">Cannot access: Other counties</text>

  <!-- JWT for User 2 (Multiple Counties) -->
  <rect x="440" y="850" width="280" height="130" rx="5" fill="#ffffff" stroke="#16a34a" stroke-width="2"/>
  <text x="580" y="875" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#166534">
    jane.smith JWT Token
  </text>
  <rect x="460" y="885" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="580" y="898" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#166534">Groups: ["County B", "County C"]</text>
  <rect x="460" y="910" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="580" y="923" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#166534">Roles: ["SUPERVISOR"]</text>
  <rect x="460" y="935" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="580" y="948" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#166534">Can Access: County B &amp; C data</text>
  <rect x="460" y="960" width="240" height="15" rx="3" fill="#fee2e2"/>
  <text x="580" y="970" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#dc2626">Cannot access: Other counties</text>

  <!-- JWT for User 3 (Multiple Counties) -->
  <rect x="750" y="850" width="280" height="130" rx="5" fill="#ffffff" stroke="#16a34a" stroke-width="2"/>
  <text x="890" y="875" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#166534">
    mike.jones JWT Token
  </text>
  <rect x="770" y="885" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="890" y="898" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#166534">Groups: ["County A", "County D", "County 25"]</text>
  <rect x="770" y="910" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="890" y="923" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#166534">Roles: ["CASE_WORKER"]</text>
  <rect x="770" y="935" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="890" y="948" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#166534">Can Access: 3 counties data</text>
  <rect x="770" y="960" width="240" height="15" rx="3" fill="#fee2e2"/>
  <text x="890" y="970" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#dc2626">Cannot access: Other counties</text>

  <!-- Authorization Flow Section -->
  <rect x="100" y="1040" width="1200" height="320" rx="5" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
  <text x="700" y="1065" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">
    Authorization Flow - Based on County Groups in JWT
  </text>

  <!-- Step 1: User Login -->
  <rect x="130" y="1090" width="200" height="110" rx="5" fill="#ffffff" stroke="#f59e0b" stroke-width="2"/>
  <text x="230" y="1115" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#92400e">
    1. User Login
  </text>
  <text x="230" y="1135" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    jane.smith authenticates
  </text>
  <text x="230" y="1150" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    Keycloak validates
  </text>
  <text x="230" y="1165" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    credentials
  </text>
  <text x="230" y="1180" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    Returns JWT token
  </text>
  <text x="230" y="1195" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#059669">
    with ALL county groups
  </text>

  <!-- Step 2: Group Resolution -->
  <rect x="360" y="1090" width="200" height="110" rx="5" fill="#ffffff" stroke="#f59e0b" stroke-width="2"/>
  <text x="460" y="1115" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#92400e">
    2. Group Resolution
  </text>
  <text x="460" y="1135" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    Keycloak checks user
  </text>
  <text x="460" y="1150" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    group membership
  </text>
  <text x="460" y="1165" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    Finds: County B, County C
  </text>
  <text x="460" y="1180" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    (multiple groups)
  </text>
  <text x="460" y="1195" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#059669">
    All added to JWT
  </text>

  <!-- Step 3: Token Issued -->
  <rect x="590" y="1090" width="200" height="110" rx="5" fill="#ffffff" stroke="#f59e0b" stroke-width="2"/>
  <text x="690" y="1115" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#92400e">
    3. JWT Token Issued
  </text>
  <text x="690" y="1135" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    Token contains:
  </text>
  <text x="690" y="1150" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">
    - User ID
  </text>
  <text x="690" y="1165" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">
    - Groups: [County B, County C]
  </text>
  <text x="690" y="1180" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">
    - Roles: [SUPERVISOR]
  </text>
  <text x="690" y="1195" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#059669">
    (all county groups)
  </text>

  <!-- Step 4: API Request -->
  <rect x="820" y="1090" width="200" height="110" rx="5" fill="#ffffff" stroke="#f59e0b" stroke-width="2"/>
  <text x="920" y="1115" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#92400e">
    4. API Request
  </text>
  <text x="920" y="1135" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    User makes API call
  </text>
  <text x="920" y="1150" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    GET /api/recipients
  </text>
  <text x="920" y="1165" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    ?county=County B
  </text>
  <text x="920" y="1180" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">
    (or County C)
  </text>
  <text x="920" y="1195" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">
    Token sent with request
  </text>

  <!-- Step 5: Authorization Check -->
  <rect x="1050" y="1090" width="230" height="110" rx="5" fill="#ffffff" stroke="#f59e0b" stroke-width="2"/>
  <text x="1165" y="1115" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#92400e">
    5. Authorization Check
  </text>
  <text x="1165" y="1135" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    Backend extracts
  </text>
  <text x="1165" y="1150" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    county groups from JWT
  </text>
  <text x="1165" y="1165" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    Checks if requested
  </text>
  <text x="1165" y="1180" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">
    county is in groups
  </text>
  <text x="1165" y="1195" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#059669">
    [County B, County C]
  </text>

  <!-- Authorization Decision -->
  <rect x="130" y="1220" width="1150" height="120" rx="5" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
  <text x="705" y="1245" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#166534">
    Authorization Decision Examples
  </text>
  <text x="150" y="1270" font-family="Arial, sans-serif" font-size="11" fill="#166534">
    Request: GET /api/recipients?county=County B
  </text>
  <text x="150" y="1290" font-family="Arial, sans-serif" font-size="11" fill="#16a34a">
    ✓ User JWT has [County B, County C] → County B is in list → AUTHORIZED → Return County B data
  </text>
  <text x="600" y="1270" font-family="Arial, sans-serif" font-size="11" fill="#166534">
    Request: GET /api/recipients?county=County C
  </text>
  <text x="600" y="1290" font-family="Arial, sans-serif" font-size="11" fill="#16a34a">
    ✓ User JWT has [County B, County C] → County C is in list → AUTHORIZED → Return County C data
  </text>
  <text x="150" y="1310" font-family="Arial, sans-serif" font-size="11" fill="#166534">
    Request: GET /api/recipients?county=County A
  </text>
  <text x="150" y="1330" font-family="Arial, sans-serif" font-size="11" fill="#dc2626">
    ✗ User JWT has [County B, County C] → County A NOT in list → DENIED → 403 Forbidden
  </text>
  <text x="600" y="1310" font-family="Arial, sans-serif" font-size="11" fill="#166534">
    Request: GET /api/recipients?county=County 25
  </text>
  <text x="600" y="1330" font-family="Arial, sans-serif" font-size="11" fill="#dc2626">
    ✗ User JWT has [County B, County C] → County 25 NOT in list → DENIED → 403 Forbidden
  </text>

  <!-- Policy Enforcement Section -->
  <rect x="100" y="1380" width="1200" height="100" rx="5" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
  <text x="700" y="1405" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#991b1b">
    Policy Enforcement - County-Based Data Filtering
  </text>
  <text x="150" y="1430" font-family="Arial, sans-serif" font-size="11" fill="#991b1b">
    Backend API extracts ALL county groups from JWT token → User can access data for ANY county in their groups list
  </text>
  <text x="150" y="1450" font-family="Arial, sans-serif" font-size="11" fill="#991b1b">
    Example: User with JWT groups [County A, County D, County 25] can access data for all three counties, but NOT for County B, C, or any other county
  </text>
  <text x="150" y="1470" font-family="Arial, sans-serif" font-size="11" fill="#991b1b">
    Database query: SELECT * FROM recipients WHERE county IN ('County A', 'County D', 'County 25') - Only returns data for counties in JWT groups
  </text>

  <!-- Summary Box -->
  <rect x="100" y="1520" width="1200" height="120" rx="5" fill="#dbeafe" stroke="#2563eb" stroke-width="2"/>
  <text x="700" y="1545" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#1e40af">
    Summary: County Groups in JWT Token
  </text>
  <text x="150" y="1570" font-family="Arial, sans-serif" font-size="11" fill="#1e40af">
    • County Groups: Define which counties' data a user can access - User can belong to ONE or MULTIPLE county groups
  </text>
  <text x="150" y="1590" font-family="Arial, sans-serif" font-size="11" fill="#1e40af">
    • JWT Token: Contains ALL county groups the user belongs to as an array: ["County A", "County B", "County C"]
  </text>
  <text x="600" y="1570" font-family="Arial, sans-serif" font-size="11" fill="#1e40af">
    • Authorization: Backend checks if requested county is in the JWT groups array - If yes, allow access; if no, deny
  </text>
  <text x="600" y="1590" font-family="Arial, sans-serif" font-size="11" fill="#1e40af">
    • Data Access: User can access data for ALL counties listed in their JWT token groups array
  </text>
  <text x="150" y="1610" font-family="Arial, sans-serif" font-size="11" fill="#1e40af">
    • Example: jane.smith belongs to [County B, County C] → JWT contains both → Can access County B and County C data → Cannot access other counties
  </text>
  <text x="600" y="1610" font-family="Arial, sans-serif" font-size="11" fill="#1e40af">
    • Roles: Assigned separately (CASE_WORKER, SUPERVISOR, etc.) - Independent of county groups
  </text>

  <!-- Arrow markers -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#3b82f6"/>
    </marker>
  </defs>

  <!-- Legend -->
  <rect x="100" y="1680" width="1200" height="20" rx="5" fill="#f9fafb" stroke="#6b7280" stroke-width="1"/>
  <text x="120" y="1695" font-family="Arial, sans-serif" font-size="10" fill="#4b5563">
    <tspan font-weight="bold">Legend:</tspan> County Groups (Data Access Scope) + Roles (Permissions) = Complete Authorization | JWT Contains All County Groups User Belongs To
  </text>
</svg>
