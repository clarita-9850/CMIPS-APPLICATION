<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 1800" style="background-color: #ffffff;">
  <!-- Title -->
  <text x="700" y="30" font-family="Arial, sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    Password Change Flow for Newly Created User by Admin
  </text>
  <text x="700" y="55" font-family="Arial, sans-serif" font-size="14" text-anchor="middle" fill="#6b7280">
    Complete Flow from User Creation to First Login and Password Change
  </text>

  <!-- Phase 1: Admin Creates User -->
  <rect x="50" y="80" width="1300" height="280" rx="10" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
  <text x="700" y="105" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#92400e">
    Phase 1: Admin Creates New User
  </text>

  <!-- Admin Dashboard -->
  <rect x="100" y="130" width="250" height="200" rx="5" fill="#ffffff" stroke="#f59e0b" stroke-width="2"/>
  <text x="225" y="155" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">
    Admin Dashboard
  </text>
  <text x="225" y="180" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#4b5563">
    (Keycloak Admin UI)
  </text>
  <rect x="120" y="195" width="210" height="20" rx="3" fill="#fef3c7"/>
  <text x="225" y="208" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#92400e">Admin fills user form:</text>
  <rect x="120" y="220" width="210" height="15" rx="3" fill="#fee2e2"/>
  <text x="225" y="231" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">• Username: newuser</text>
  <rect x="120" y="240" width="210" height="15" rx="3" fill="#fee2e2"/>
  <text x="225" y="251" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">• Email: newuser@cmips.com</text>
  <rect x="120" y="260" width="210" height="15" rx="3" fill="#fee2e2"/>
  <text x="225" y="271" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">• Password: TempPass123!</text>
  <rect x="120" y="280" width="210" height="15" rx="3" fill="#fee2e2"/>
  <text x="225" y="291" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">• Role: CASE_WORKER</text>
  <rect x="120" y="300" width="210" height="25" rx="3" fill="#dcfce7"/>
  <text x="225" y="317" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">✓ Temporary Password: true</text>

  <!-- Backend API -->
  <rect x="380" y="130" width="280" height="200" rx="5" fill="#ffffff" stroke="#3b82f6" stroke-width="2"/>
  <text x="520" y="155" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#1e40af">
    Backend API
  </text>
  <text x="520" y="180" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#4b5563">
    POST /api/admin/keycloak/users
  </text>
  <rect x="400" y="195" width="240" height="20" rx="3" fill="#dbeafe"/>
  <text x="520" y="208" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#1e40af">KeycloakAdminController</text>
  <rect x="400" y="220" width="240" height="20" rx="3" fill="#dbeafe"/>
  <text x="520" y="233" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#1e40af">KeycloakAdminService.createUser()</text>
  <rect x="400" y="245" width="240" height="20" rx="3" fill="#e9d5ff"/>
  <text x="520" y="258" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b21a8">Request payload:</text>
  <rect x="400" y="270" width="240" height="15" rx="3" fill="#f3e8ff"/>
  <text x="520" y="280" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#4b5563">{username, email, password, temporary: true}</text>
  <rect x="400" y="290" width="240" height="15" rx="3" fill="#f3e8ff"/>
  <text x="520" y="300" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#4b5563">role: CASE_WORKER</text>
  <rect x="400" y="310" width="240" height="15" rx="3" fill="#dcfce7"/>
  <text x="520" y="320" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">✓ User created successfully</text>

  <!-- Keycloak -->
  <rect x="690" y="130" width="280" height="200" rx="5" fill="#ffffff" stroke="#9333ea" stroke-width="2"/>
  <text x="830" y="155" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#6b21a8">
    Keycloak
  </text>
  <text x="830" y="180" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#4b5563">
    POST /admin/realms/cmips/users
  </text>
  <rect x="710" y="195" width="240" height="20" rx="3" fill="#f3e8ff"/>
  <text x="830" y="208" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#6b21a8">Creates user in realm</text>
  <rect x="710" y="220" width="240" height="20" rx="3" fill="#f3e8ff"/>
  <text x="830" y="233" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#6b21a8">Sets credentials:</text>
  <rect x="710" y="245" width="240" height="15" rx="3" fill="#e9d5ff"/>
  <text x="830" y="255" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b21a8">type: "password"</text>
  <rect x="710" y="265" width="240" height="15" rx="3" fill="#e9d5ff"/>
  <text x="830" y="275" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b21a8">value: "TempPass123!"</text>
  <rect x="710" y="285" width="240" height="15" rx="3" fill="#dcfce7"/>
  <text x="830" y="295" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">temporary: true ✓</text>
  <rect x="710" y="305" width="240" height="20" rx="3" fill="#f3e8ff"/>
  <text x="830" y="318" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b21a8">Assigns role: CASE_WORKER</text>

  <!-- Database -->
  <rect x="1000" y="130" width="320" height="200" rx="5" fill="#ffffff" stroke="#059669" stroke-width="2"/>
  <text x="1160" y="155" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#047857">
    Keycloak Database
  </text>
  <text x="1160" y="180" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#4b5563">
    (User Storage)
  </text>
  <rect x="1020" y="195" width="280" height="20" rx="3" fill="#d1fae5"/>
  <text x="1160" y="208" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#047857">User Record Created:</text>
  <rect x="1020" y="220" width="280" height="15" rx="3" fill="#f0fdf4"/>
  <text x="1160" y="230" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">• userId: abc-123-def</text>
  <rect x="1020" y="250" width="280" height="15" rx="3" fill="#f0fdf4"/>
  <text x="1160" y="260" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">• username: newuser</text>
  <rect x="1020" y="270" width="280" height="15" rx="3" fill="#f0fdf4"/>
  <text x="1160" y="280" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">• password: TempPass123! (hashed)</text>
  <rect x="1020" y="290" width="280" height="15" rx="3" fill="#dcfce7"/>
  <text x="1160" y="300" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">• temporary: true</text>
  <rect x="1020" y="310" width="280" height="15" rx="3" fill="#f0fdf4"/>
  <text x="1160" y="320" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">• requiredActions: ["UPDATE_PASSWORD"]</text>

  <!-- Arrows Phase 1 -->
  <path d="M 350 230 L 380 230" stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 660 230 L 690 230" stroke="#9333ea" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 970 230 L 1000 230" stroke="#059669" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="365" y="225" font-family="Arial, sans-serif" font-size="9" fill="#3b82f6">API Call</text>
  <text x="675" y="225" font-family="Arial, sans-serif" font-size="9" fill="#9333ea">Create User</text>
  <text x="985" y="225" font-family="Arial, sans-serif" font-size="9" fill="#059669">Store</text>

  <!-- Phase 2: New User Login -->
  <rect x="50" y="400" width="1300" height="320" rx="10" fill="#dbeafe" stroke="#2563eb" stroke-width="2"/>
  <text x="700" y="425" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#1e40af">
    Phase 2: New User First Login Attempt
  </text>

  <!-- Frontend Login -->
  <rect x="100" y="450" width="250" height="240" rx="5" fill="#ffffff" stroke="#2563eb" stroke-width="2"/>
  <text x="225" y="475" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#1e40af">
    Frontend Login Page
  </text>
  <rect x="120" y="490" width="210" height="20" rx="3" fill="#dbeafe"/>
  <text x="225" y="503" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#1e40af">User enters:</text>
  <rect x="120" y="515" width="210" height="15" rx="3" fill="#f0f9ff"/>
  <text x="225" y="525" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">Username: newuser</text>
  <rect x="120" y="535" width="210" height="15" rx="3" fill="#f0f9ff"/>
  <text x="225" y="545" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">Password: TempPass123!</text>
  <rect x="120" y="555" width="210" height="20" rx="3" fill="#dbeafe"/>
  <text x="225" y="568" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#1e40af">Clicks "Sign In"</text>
  <rect x="120" y="580" width="210" height="20" rx="3" fill="#fee2e2"/>
  <text x="225" y="593" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#dc2626">POST /api/auth/login</text>
  <rect x="120" y="605" width="210" height="20" rx="3" fill="#fee2e2"/>
  <text x="225" y="618" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#dc2626">Request: {username, password}</text>
  <rect x="120" y="630" width="210" height="15" rx="3" fill="#f0f9ff"/>
  <text x="225" y="640" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#4b5563">AuthContext.login()</text>
  <rect x="120" y="650" width="210" height="35" rx="3" fill="#dcfce7"/>
  <text x="225" y="665" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">Waiting for response...</text>
  <text x="225" y="680" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">(with password change flag)</text>

  <!-- Backend Auth Controller -->
  <rect x="380" y="450" width="280" height="240" rx="5" fill="#ffffff" stroke="#3b82f6" stroke-width="2"/>
  <text x="520" y="475" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#1e40af">
    Backend AuthController
  </text>
  <text x="520" y="495" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#4b5563">
    POST /api/auth/login
  </text>
  <rect x="400" y="505" width="240" height="20" rx="3" fill="#dbeafe"/>
  <text x="520" y="518" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#1e40af">Receives login request</text>
  <rect x="400" y="530" width="240" height="20" rx="3" fill="#dbeafe"/>
  <text x="520" y="543" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#1e40af">Prepares Keycloak token request</text>
  <rect x="400" y="555" width="240" height="20" rx="3" fill="#fee2e2"/>
  <text x="520" y="568" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#dc2626">POST to Keycloak:</text>
  <rect x="400" y="580" width="240" height="15" rx="3" fill="#f0f9ff"/>
  <text x="520" y="590" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#4b5563">/protocol/openid-connect/token</text>
  <rect x="400" y="600" width="240" height="15" rx="3" fill="#f0f9ff"/>
  <text x="520" y="610" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#4b5563">grant_type=password</text>
  <rect x="400" y="620" width="240" height="15" rx="3" fill="#f0f9ff"/>
  <text x="520" y="630" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#4b5563">username=newuser</text>
  <rect x="400" y="640" width="240" height="15" rx="3" fill="#f0f9ff"/>
  <text x="520" y="650" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#4b5563">password=TempPass123!</text>
  <rect x="400" y="655" width="240" height="30" rx="3" fill="#dcfce7"/>
  <text x="520" y="670" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">Forwards to Keycloak</text>
  <text x="520" y="685" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">for authentication</text>

  <!-- Keycloak Authentication -->
  <rect x="690" y="450" width="280" height="240" rx="5" fill="#ffffff" stroke="#9333ea" stroke-width="2"/>
  <text x="830" y="475" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#6b21a8">
    Keycloak Authentication
  </text>
  <text x="830" y="495" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#4b5563">
    /protocol/openid-connect/token
  </text>
  <rect x="710" y="505" width="240" height="20" rx="3" fill="#f3e8ff"/>
  <text x="830" y="518" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#6b21a8">1. Validates credentials</text>
  <rect x="710" y="530" width="240" height="20" rx="3" fill="#f3e8ff"/>
  <text x="830" y="543" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#6b21a8">2. Checks user status</text>
  <rect x="710" y="555" width="240" height="20" rx="3" fill="#fef3c7"/>
  <text x="830" y="568" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#92400e">3. Detects temporary password</text>
  <rect x="710" y="580" width="240" height="20" rx="3" fill="#fef3c7"/>
  <text x="830" y="593" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#92400e">4. Checks requiredActions</text>
  <rect x="710" y="605" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="830" y="618" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">5. Returns token + flag</text>
  <rect x="710" y="630" width="240" height="15" rx="3" fill="#e9d5ff"/>
  <text x="830" y="640" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b21a8">Response includes:</text>
  <rect x="710" y="650" width="240" height="15" rx="3" fill="#e9d5ff"/>
  <text x="830" y="660" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b21a8">• access_token (JWT)</text>
  <rect x="710" y="670" width="240" height="15" rx="3" fill="#dcfce7"/>
  <text x="830" y="680" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">• requiredActions: ["UPDATE_PASSWORD"]</text>

  <!-- Response Processing -->
  <rect x="1000" y="450" width="320" height="240" rx="5" fill="#ffffff" stroke="#059669" stroke-width="2"/>
  <text x="1160" y="475" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#047857">
    Backend Response Processing
  </text>
  <rect x="1020" y="505" width="280" height="20" rx="3" fill="#d1fae5"/>
  <text x="1160" y="518" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#047857">Receives Keycloak response</text>
  <rect x="1020" y="530" width="280" height="20" rx="3" fill="#fef3c7"/>
  <text x="1160" y="543" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#92400e">Checks requiredActions</text>
  <rect x="1020" y="555" width="280" height="20" rx="3" fill="#dcfce7"/>
  <text x="1160" y="568" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">If "UPDATE_PASSWORD" exists:</text>
  <rect x="1020" y="580" width="280" height="15" rx="3" fill="#f0fdf4"/>
  <text x="1160" y="590" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">Set forcePasswordChange = true</text>
  <rect x="1020" y="600" width="280" height="20" rx="3" fill="#d1fae5"/>
  <text x="1160" y="613" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#047857">Returns to frontend:</text>
  <rect x="1020" y="625" width="280" height="15" rx="3" fill="#e9d5ff"/>
  <text x="1160" y="635" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b21a8">{access_token, refresh_token,</text>
  <rect x="1020" y="645" width="280" height="15" rx="3" fill="#dcfce7"/>
  <text x="1160" y="655" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">forcePasswordChange: true}</text>
  <rect x="1020" y="665" width="280" height="20" rx="3" fill="#fee2e2"/>
  <text x="1160" y="678" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#dc2626">User cannot proceed</text>
  <text x="1160" y="690" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#dc2626">until password changed</text>

  <!-- Arrows Phase 2 -->
  <path d="M 350 570 L 380 570" stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 660 570 L 690 570" stroke="#9333ea" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 970 570 L 1000 570" stroke="#059669" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="365" y="565" font-family="Arial, sans-serif" font-size="9" fill="#3b82f6">Login Request</text>
  <text x="675" y="565" font-family="Arial, sans-serif" font-size="9" fill="#9333ea">Authenticate</text>
  <text x="985" y="565" font-family="Arial, sans-serif" font-size="9" fill="#059669">Process</text>

  <!-- Phase 3: Password Change Modal -->
  <rect x="50" y="760" width="1300" height="280" rx="10" fill="#f3e8ff" stroke="#9333ea" stroke-width="2"/>
  <text x="700" y="785" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#6b21a8">
    Phase 3: Password Change Modal Appears
  </text>

  <!-- Frontend AuthContext -->
  <rect x="100" y="810" width="280" height="200" rx="5" fill="#ffffff" stroke="#9333ea" stroke-width="2"/>
  <text x="240" y="835" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#6b21a8">
    Frontend AuthContext
  </text>
  <rect x="120" y="855" width="240" height="20" rx="3" fill="#f3e8ff"/>
  <text x="240" y="868" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#6b21a8">Receives login response</text>
  <rect x="120" y="880" width="240" height="20" rx="3" fill="#fef3c7"/>
  <text x="240" y="893" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#92400e">Checks: forcePasswordChange</text>
  <rect x="120" y="905" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="240" y="918" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">If true:</text>
  <rect x="120" y="930" width="240" height="15" rx="3" fill="#e9d5ff"/>
  <text x="240" y="940" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b21a8">• setForcePasswordChange(true)</text>
  <rect x="120" y="950" width="240" height="15" rx="3" fill="#e9d5ff"/>
  <text x="240" y="960" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b21a8">• setShowChangePasswordModal(true)</text>
  <rect x="120" y="970" width="240" height="15" rx="3" fill="#e9d5ff"/>
  <text x="240" y="980" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b21a8">• Store token (user logged in)</text>
  <rect x="120" y="990" width="240" height="15" rx="3" fill="#fee2e2"/>
  <text x="240" y="1000" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#dc2626">• Do NOT redirect yet</text>

  <!-- Change Password Modal -->
  <rect x="410" y="810" width="280" height="200" rx="5" fill="#ffffff" stroke="#9333ea" stroke-width="2"/>
  <text x="550" y="835" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#6b21a8">
    ChangePasswordModal
  </text>
  <rect x="430" y="855" width="240" height="20" rx="3" fill="#f3e8ff"/>
  <text x="550" y="868" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#6b21a8">Modal appears automatically</text>
  <rect x="430" y="880" width="240" height="20" rx="3" fill="#fee2e2"/>
  <text x="550" y="893" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#dc2626">Cannot be closed</text>
  <rect x="430" y="905" width="240" height="20" rx="3" fill="#f0f9ff"/>
  <text x="550" y="918" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">User must fill form:</text>
  <rect x="430" y="930" width="240" height="15" rx="3" fill="#f0f9ff"/>
  <text x="550" y="940" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">• Current Password: TempPass123!</text>
  <rect x="430" y="950" width="240" height="15" rx="3" fill="#f0f9ff"/>
  <text x="550" y="960" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">• New Password: MyNewPass123!</text>
  <rect x="430" y="970" width="240" height="15" rx="3" fill="#f0f9ff"/>
  <text x="550" y="980" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">• Confirm Password: MyNewPass123!</text>
  <rect x="430" y="990" width="240" height="15" rx="3" fill="#dcfce7"/>
  <text x="550" y="1000" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">✓ Validates: min 8 chars, match</text>

  <!-- User Action -->
  <rect x="720" y="810" width="280" height="200" rx="5" fill="#ffffff" stroke="#9333ea" stroke-width="2"/>
  <text x="860" y="835" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#6b21a8">
    User Action
  </text>
  <rect x="740" y="855" width="240" height="20" rx="3" fill="#f3e8ff"/>
  <text x="860" y="868" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#6b21a8">User sees modal</text>
  <rect x="740" y="880" width="240" height="20" rx="3" fill="#fef3c7"/>
  <text x="860" y="893" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#92400e">"Change Password Required"</text>
  <rect x="740" y="905" width="240" height="20" rx="3" fill="#f0f9ff"/>
  <text x="860" y="918" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">Enters current &amp; new password</text>
  <rect x="740" y="930" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="860" y="943" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">Clicks "Change Password"</text>
  <rect x="740" y="955" width="240" height="20" rx="3" fill="#fee2e2"/>
  <text x="860" y="968" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#dc2626">POST /api/auth/change-password</text>
  <rect x="740" y="980" width="240" height="15" rx="3" fill="#f0f9ff"/>
  <text x="860" y="990" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">Request: {currentPassword, newPassword}</text>
  <rect x="740" y="1000" width="240" height="5" rx="3" fill="#f3e8ff"/>

  <!-- Arrows Phase 3 -->
  <path d="M 380 910 L 410 910" stroke="#9333ea" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 690 910 L 720 910" stroke="#9333ea" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="395" y="905" font-family="Arial, sans-serif" font-size="9" fill="#9333ea">Shows Modal</text>
  <text x="705" y="905" font-family="Arial, sans-serif" font-size="9" fill="#9333ea">User Fills</text>

  <!-- Phase 4: Password Update -->
  <rect x="50" y="1080" width="1300" height="320" rx="10" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
  <text x="700" y="1105" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#166534">
    Phase 4: Password Update in Keycloak
  </text>

  <!-- Backend Password Change -->
  <rect x="100" y="1130" width="280" height="240" rx="5" fill="#ffffff" stroke="#16a34a" stroke-width="2"/>
  <text x="240" y="1155" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#166534">
    Backend API
  </text>
  <text x="240" y="1175" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#4b5563">
    POST /api/auth/change-password
  </text>
  <rect x="120" y="1185" width="240" height="20" rx="3" fill="#d1fae5"/>
  <text x="240" y="1198" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#166534">Receives password change request</text>
  <rect x="120" y="1210" width="240" height="20" rx="3" fill="#d1fae5"/>
  <text x="240" y="1223" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#166534">Extracts JWT token from header</text>
  <rect x="120" y="1235" width="240" height="20" rx="3" fill="#d1fae5"/>
  <text x="240" y="1248" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#166534">Gets userId from token</text>
  <rect x="120" y="1260" width="240" height="20" rx="3" fill="#fee2e2"/>
  <text x="240" y="1273" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#dc2626">Validates current password</text>
  <rect x="120" y="1285" width="240" height="20" rx="3" fill="#fee2e2"/>
  <text x="240" y="1298" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#dc2626">Validates new password rules</text>
  <rect x="120" y="1310" width="240" height="20" rx="3" fill="#d1fae5"/>
  <text x="240" y="1323" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#166534">Calls Keycloak Admin API</text>
  <rect x="120" y="1335" width="240" height="30" rx="3" fill="#dcfce7"/>
  <text x="240" y="1350" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">PUT /admin/realms/cmips/users/{userId}/reset-password</text>
  <text x="240" y="1365" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">or update credentials</text>

  <!-- Keycloak Password Update -->
  <rect x="410" y="1130" width="280" height="240" rx="5" fill="#ffffff" stroke="#9333ea" stroke-width="2"/>
  <text x="550" y="1155" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#6b21a8">
    Keycloak Admin API
  </text>
  <text x="550" y="1175" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#4b5563">
    PUT /admin/realms/cmips/users/{userId}
  </text>
  <rect x="430" y="1185" width="240" height="20" rx="3" fill="#f3e8ff"/>
  <text x="550" y="1198" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#6b21a8">1. Validates admin token</text>
  <rect x="430" y="1210" width="240" height="20" rx="3" fill="#f3e8ff"/>
  <text x="550" y="1223" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#6b21a8">2. Updates user credentials</text>
  <rect x="430" y="1235" width="240" height="20" rx="3" fill="#f3e8ff"/>
  <text x="550" y="1248" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#6b21a8">3. Sets new password</text>
  <rect x="430" y="1260" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="550" y="1273" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">4. Removes temporary flag</text>
  <rect x="430" y="1285" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="550" y="1298" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">5. Removes UPDATE_PASSWORD</text>
  <rect x="430" y="1310" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="550" y="1323" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">from requiredActions</text>
  <rect x="430" y="1335" width="240" height="30" rx="3" fill="#f3e8ff"/>
  <text x="550" y="1350" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b21a8">Password updated successfully</text>
  <text x="550" y="1365" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6b21a8">User can now login normally</text>

  <!-- Database Update -->
  <rect x="720" y="1130" width="280" height="240" rx="5" fill="#ffffff" stroke="#059669" stroke-width="2"/>
  <text x="860" y="1155" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#047857">
    Keycloak Database
  </text>
  <text x="860" y="1175" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#4b5563">
    (User Record Updated)
  </text>
  <rect x="740" y="1185" width="240" height="20" rx="3" fill="#d1fae5"/>
  <text x="860" y="1198" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#047857">User Record Updated:</text>
  <rect x="740" y="1210" width="240" height="15" rx="3" fill="#f0fdf4"/>
  <text x="860" y="1220" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#4b5563">• password: MyNewPass123! (hashed)</text>
  <rect x="740" y="1230" width="240" height="15" rx="3" fill="#dcfce7"/>
  <text x="860" y="1240" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">• temporary: false ✓</text>
  <rect x="740" y="1250" width="240" height="15" rx="3" fill="#dcfce7"/>
  <text x="860" y="1260" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">• requiredActions: [] ✓</text>
  <rect x="740" y="1270" width="240" height="20" rx="3" fill="#d1fae5"/>
  <text x="860" y="1283" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#047857">User status:</text>
  <rect x="740" y="1295" width="240" height="15" rx="3" fill="#dcfce7"/>
  <text x="860" y="1305" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">• Password is permanent</text>
  <rect x="740" y="1315" width="240" height="15" rx="3" fill="#dcfce7"/>
  <text x="860" y="1325" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">• No password change required</text>
  <rect x="740" y="1335" width="240" height="30" rx="3" fill="#d1fae5"/>
  <text x="860" y="1350" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#047857">User can login normally</text>
  <text x="860" y="1365" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#047857">on next login</text>

  <!-- Response Back -->
  <rect x="1030" y="1130" width="280" height="240" rx="5" fill="#ffffff" stroke="#16a34a" stroke-width="2"/>
  <text x="1170" y="1155" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#166534">
    Response to Frontend
  </text>
  <rect x="1050" y="1185" width="240" height="20" rx="3" fill="#d1fae5"/>
  <text x="1170" y="1198" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#166534">Backend returns:</text>
  <rect x="1050" y="1210" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="1170" y="1223" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">{success: true}</text>
  <rect x="1050" y="1235" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="1170" y="1248" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">message: "Password changed"</text>
  <rect x="1050" y="1260" width="240" height="20" rx="3" fill="#d1fae5"/>
  <text x="1170" y="1273" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#166534">Frontend receives response</text>
  <rect x="1050" y="1285" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="1170" y="1298" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">Calls onSuccess() callback</text>
  <rect x="1050" y="1310" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="1170" y="1323" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">Closes modal</text>
  <rect x="1050" y="1335" width="240" height="30" rx="3" fill="#dcfce7"/>
  <text x="1170" y="1350" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">Redirects to dashboard</text>
  <text x="1170" y="1365" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">User can now access system</text>

  <!-- Arrows Phase 4 -->
  <path d="M 380 1250 L 410 1250" stroke="#16a34a" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 690 1250 L 720 1250" stroke="#9333ea" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 1000 1250 L 1030 1250" stroke="#059669" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="395" y="1245" font-family="Arial, sans-serif" font-size="9" fill="#16a34a">Update Request</text>
  <text x="705" y="1245" font-family="Arial, sans-serif" font-size="9" fill="#9333ea">Update Password</text>
  <text x="1015" y="1245" font-family="Arial, sans-serif" font-size="9" fill="#059669">Store</text>

  <!-- Phase 5: Success and Access -->
  <rect x="50" y="1440" width="1300" height="280" rx="10" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
  <text x="700" y="1465" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#166534">
    Phase 5: User Can Now Access System
  </text>

  <!-- Modal Closes -->
  <rect x="100" y="1490" width="280" height="200" rx="5" fill="#ffffff" stroke="#16a34a" stroke-width="2"/>
  <text x="240" y="1515" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#166534">
    Frontend Action
  </text>
  <rect x="120" y="1535" width="240" height="20" rx="3" fill="#d1fae5"/>
  <text x="240" y="1548" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#166534">onSuccess() callback triggered</text>
  <rect x="120" y="1560" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="240" y="1573" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">setForcePasswordChange(false)</text>
  <rect x="120" y="1580" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="240" y="1593" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">setShowChangePasswordModal(false)</text>
  <rect x="120" y="1605" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="240" y="1618" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">Modal closes</text>
  <rect x="120" y="1630" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="240" y="1643" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">window.location.href = '/'</text>
  <rect x="120" y="1655" width="240" height="30" rx="3" fill="#d1fae5"/>
  <text x="240" y="1670" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#166534">User redirected to dashboard</text>
  <text x="240" y="1685" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#166534">based on role</text>

  <!-- User Dashboard -->
  <rect x="410" y="1490" width="280" height="200" rx="5" fill="#ffffff" stroke="#16a34a" stroke-width="2"/>
  <text x="550" y="1515" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#166534">
    User Dashboard
  </text>
  <rect x="430" y="1535" width="240" height="20" rx="3" fill="#d1fae5"/>
  <text x="550" y="1548" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#166534">User lands on dashboard</text>
  <rect x="430" y="1560" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="550" y="1573" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">JWT token is valid</text>
  <rect x="430" y="1580" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="550" y="1593" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">No password change required</text>
  <rect x="430" y="1605" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="550" y="1618" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">User can access all features</text>
  <rect x="430" y="1630" width="240" height="20" rx="3" fill="#d1fae5"/>
  <text x="550" y="1643" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#166534">Example: CASE_WORKER dashboard</text>
  <rect x="430" y="1655" width="240" height="30" rx="3" fill="#dcfce7"/>
  <text x="550" y="1670" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">User can now work normally</text>
  <text x="550" y="1685" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">Password is permanent</text>

  <!-- Future Logins -->
  <rect x="720" y="1490" width="280" height="200" rx="5" fill="#ffffff" stroke="#16a34a" stroke-width="2"/>
  <text x="860" y="1515" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#166534">
    Future Logins
  </text>
  <rect x="740" y="1535" width="240" height="20" rx="3" fill="#d1fae5"/>
  <text x="860" y="1548" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#166534">User logs in again</text>
  <rect x="740" y="1560" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="860" y="1573" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">Username: newuser</text>
  <rect x="740" y="1580" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="860" y="1593" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">Password: MyNewPass123!</text>
  <rect x="740" y="1605" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="860" y="1618" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">Keycloak validates</text>
  <rect x="740" y="1630" width="240" height="20" rx="3" fill="#dcfce7"/>
  <text x="860" y="1643" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a34a">No temporary password</text>
  <rect x="740" y="1655" width="240" height="30" rx="3" fill="#dcfce7"/>
  <text x="860" y="1670" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">Returns token normally</text>
  <text x="860" y="1685" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a34a">No password change required</text>

  <!-- Key Points Box -->
  <rect x="1030" y="1490" width="280" height="200" rx="5" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
  <text x="1170" y="1515" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">
    Key Points
  </text>
  <text x="1050" y="1540" font-family="Arial, sans-serif" font-size="10" fill="#92400e">
    • Admin creates user with temporary: true
  </text>
  <text x="1050" y="1560" font-family="Arial, sans-serif" font-size="10" fill="#92400e">
    • Keycloak sets requiredActions: ["UPDATE_PASSWORD"]
  </text>
  <text x="1050" y="1580" font-family="Arial, sans-serif" font-size="10" fill="#92400e">
    • First login returns forcePasswordChange flag
  </text>
  <text x="1050" y="1600" font-family="Arial, sans-serif" font-size="10" fill="#92400e">
    • Modal appears automatically (cannot close)
  </text>
  <text x="1050" y="1620" font-family="Arial, sans-serif" font-size="10" fill="#92400e">
    • User must change password to proceed
  </text>
  <text x="1050" y="1640" font-family="Arial, sans-serif" font-size="10" fill="#92400e">
    • After change, temporary flag removed
  </text>
  <text x="1050" y="1660" font-family="Arial, sans-serif" font-size="10" fill="#92400e">
    • User redirected to dashboard
  </text>
  <text x="1050" y="1680" font-family="Arial, sans-serif" font-size="10" fill="#92400e">
    • Future logins work normally
  </text>

  <!-- Arrow markers -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#3b82f6"/>
    </marker>
  </defs>

  <!-- Legend -->
  <rect x="50" y="1760" width="1300" height="20" rx="5" fill="#f9fafb" stroke="#6b7280" stroke-width="1"/>
  <text x="120" y="1775" font-family="Arial, sans-serif" font-size="10" fill="#4b5563">
    <tspan font-weight="bold">Flow:</tspan> Admin Creates User (Temporary Password) → User First Login → Password Change Modal → Password Updated in Keycloak → User Accesses Dashboard
  </text>
</svg>


