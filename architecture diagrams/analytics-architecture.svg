<svg width="1200" height="1400" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font-family: Arial, sans-serif; font-size: 22px; font-weight: bold; fill: #1a1a1a; }
      .section-title { font-family: Arial, sans-serif; font-size: 16px; font-weight: bold; fill: #2c3e50; }
      .box { fill: #ecf0f1; stroke: #34495e; stroke-width: 2; rx: 5; }
      .controller-box { fill: #e3f2fd; stroke: #1565c0; stroke-width: 2; rx: 5; }
      .service-box { fill: #e8f5e9; stroke: #2e7d32; stroke-width: 2; rx: 5; }
      .database-box { fill: #f3e5f5; stroke: #6a1b9a; stroke-width: 2; rx: 5; }
      .keycloak-box { fill: #e0f2f1; stroke: #00695c; stroke-width: 2; rx: 5; }
      .external-box { fill: #fff9c4; stroke: #f57f17; stroke-width: 2; rx: 5; }
      .text { font-family: Arial, sans-serif; font-size: 12px; fill: #2c3e50; }
      .text-small { font-family: Arial, sans-serif; font-size: 10px; fill: #555; }
      .text-bold { font-family: Arial, sans-serif; font-size: 12px; font-weight: bold; fill: #2c3e50; }
      .arrow { stroke: #34495e; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-dashed { stroke: #7f8c8d; stroke-width: 1.5; fill: none; stroke-dasharray: 5,5; marker-end: url(#arrowhead); }
      .label { font-family: Arial, sans-serif; font-size: 10px; fill: #555; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#34495e" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="600" y="30" text-anchor="middle" class="title">Analytics Architecture</text>
  <text x="600" y="50" text-anchor="middle" class="text-small">IHSS Pipeline - Real-Time Analytics &amp; Dashboard Metrics</text>

  <!-- CLIENT LAYER -->
  <rect x="50" y="70" width="1100" height="100" class="external-box" opacity="0.2"/>
  <text x="600" y="95" text-anchor="middle" class="section-title">Client Applications</text>
  
  <rect x="100" y="110" width="180" height="50" class="external-box"/>
  <text x="190" y="130" text-anchor="middle" class="text-bold">Tableau</text>
  <text x="190" y="145" text-anchor="middle" class="text-small">BI Dashboard</text>
  <text x="190" y="157" text-anchor="middle" class="text-small">Data visualization</text>

  <rect x="320" y="110" width="180" height="50" class="external-box"/>
  <text x="410" y="130" text-anchor="middle" class="text-bold">Power BI</text>
  <text x="410" y="145" text-anchor="middle" class="text-small">Business Intelligence</text>
  <text x="410" y="157" text-anchor="middle" class="text-small">Analytics platform</text>

  <rect x="540" y="110" width="180" height="50" class="external-box"/>
  <text x="630" y="130" text-anchor="middle" class="text-bold">Web Dashboard</text>
  <text x="630" y="145" text-anchor="middle" class="text-small">React/Next.js</text>
  <text x="630" y="157" text-anchor="middle" class="text-small">Real-time metrics</text>

  <rect x="760" y="110" width="180" height="50" class="external-box"/>
  <text x="850" y="130" text-anchor="middle" class="text-bold">Custom Apps</text>
  <text x="850" y="145" text-anchor="middle" class="text-small">REST API clients</text>
  <text x="850" y="157" text-anchor="middle" class="text-small">Mobile/Desktop</text>

  <rect x="980" y="110" width="120" height="50" class="external-box"/>
  <text x="1040" y="130" text-anchor="middle" class="text-bold">Excel</text>
  <text x="1040" y="145" text-anchor="middle" class="text-small">CSV export</text>
  <text x="1040" y="157" text-anchor="middle" class="text-small">Data analysis</text>

  <!-- API LAYER -->
  <rect x="50" y="190" width="1100" height="200" class="controller-box" opacity="0.2"/>
  <text x="600" y="215" text-anchor="middle" class="section-title">Analytics Controller (REST API Endpoints)</text>
  
  <!-- Real-time Metrics -->
  <rect x="100" y="230" width="200" height="70" class="controller-box"/>
  <text x="200" y="250" text-anchor="middle" class="text-bold">Real-Time Metrics</text>
  <text x="200" y="265" text-anchor="middle" class="text-small">GET /api/analytics/realtime-metrics</text>
  <text x="200" y="277" text-anchor="middle" class="text-small">• Total timesheets today</text>
  <text x="200" y="289" text-anchor="middle" class="text-small">• Pending approvals</text>
  <text x="200" y="301" text-anchor="middle" class="text-small">• Average approval time</text>

  <!-- Demographics -->
  <rect x="340" y="230" width="200" height="70" class="controller-box"/>
  <text x="440" y="250" text-anchor="middle" class="text-bold">Demographics</text>
  <text x="440" y="265" text-anchor="middle" class="text-small">GET /api/analytics/demographics/gender</text>
  <text x="440" y="277" text-anchor="middle" class="text-small">GET /api/analytics/demographics/ethnicity</text>
  <text x="440" y="289" text-anchor="middle" class="text-small">GET /api/analytics/demographics/age</text>
  <text x="440" y="301" text-anchor="middle" class="text-small">Provider &amp; Recipient data</text>

  <!-- Ad-hoc Data -->
  <rect x="580" y="230" width="200" height="70" class="controller-box"/>
  <text x="680" y="250" text-anchor="middle" class="text-bold">Ad-hoc Analytics</text>
  <text x="680" y="265" text-anchor="middle" class="text-small">GET /api/analytics/adhoc-data</text>
  <text x="680" y="277" text-anchor="middle" class="text-small">GET /api/analytics/adhoc-stats</text>
  <text x="680" y="289" text-anchor="middle" class="text-small">GET /api/analytics/adhoc-filters</text>
  <text x="680" y="301" text-anchor="middle" class="text-small">Configurable reports</text>

  <!-- County &amp; District -->
  <rect x="820" y="230" width="200" height="70" class="controller-box"/>
  <text x="920" y="250" text-anchor="middle" class="text-bold">Geographic Analytics</text>
  <text x="920" y="265" text-anchor="middle" class="text-small">GET /api/analytics/county-member-counts</text>
  <text x="920" y="277" text-anchor="middle" class="text-small">GET /api/analytics/metrics-by-county</text>
  <text x="920" y="289" text-anchor="middle" class="text-small">GET /api/analytics/metrics-by-district</text>
  <text x="920" y="301" text-anchor="middle" class="text-small">Location-based metrics</text>

  <!-- Row 2: Additional Endpoints -->
  <rect x="100" y="330" width="200" height="50" class="controller-box"/>
  <text x="200" y="350" text-anchor="middle" class="text-bold">Time Series</text>
  <text x="200" y="365" text-anchor="middle" class="text-small">GET /api/analytics/timesheets-by-year</text>
  <text x="200" y="377" text-anchor="middle" class="text-small">Historical trend analysis</text>

  <rect x="340" y="330" width="200" height="50" class="controller-box"/>
  <text x="440" y="350" text-anchor="middle" class="text-bold">Cross-Tabulation</text>
  <text x="440" y="365" text-anchor="middle" class="text-small">GET /api/analytics/adhoc-crosstab</text>
  <text x="440" y="377" text-anchor="middle" class="text-small">Multi-dimensional analysis</text>

  <rect x="580" y="330" width="200" height="50" class="controller-box"/>
  <text x="680" y="350" text-anchor="middle" class="text-bold">Filter Options</text>
  <text x="680" y="365" text-anchor="middle" class="text-small">GET /api/analytics/filters</text>
  <text x="680" y="377" text-anchor="middle" class="text-small">Available filter values</text>

  <rect x="820" y="330" width="200" height="50" class="controller-box"/>
  <text x="920" y="350" text-anchor="middle" class="text-bold">Health Check</text>
  <text x="920" y="365" text-anchor="middle" class="text-small">GET /api/analytics/health</text>
  <text x="920" y="377" text-anchor="middle" class="text-small">Service status</text>

  <!-- SECURITY LAYER -->
  <rect x="50" y="410" width="1100" height="100" class="keycloak-box" opacity="0.2"/>
  <text x="600" y="435" text-anchor="middle" class="section-title">Security &amp; Access Control</text>
  
  <rect x="100" y="455" width="200" height="45" class="keycloak-box"/>
  <text x="200" y="470" text-anchor="middle" class="text-bold">JWT Token Validation</text>
  <text x="200" y="485" text-anchor="middle" class="text-small">Spring Security OAuth2</text>
  <text x="200" y="497" text-anchor="middle" class="text-small">Keycloak issuer validation</text>

  <rect x="340" y="455" width="200" height="45" class="keycloak-box"/>
  <text x="440" y="470" text-anchor="middle" class="text-bold">County Filtering</text>
  <text x="440" y="485" text-anchor="middle" class="text-small">Extract countyId from JWT</text>
  <text x="440" y="497" text-anchor="middle" class="text-small">Enforce county restrictions</text>

  <rect x="580" y="455" width="200" height="45" class="keycloak-box"/>
  <text x="680" y="470" text-anchor="middle" class="text-bold">Role-Based Access</text>
  <text x="680" y="485" text-anchor="middle" class="text-small">SUPERVISOR, CASE_WORKER</text>
  <text x="680" y="497" text-anchor="middle" class="text-small">County-specific data only</text>

  <rect x="820" y="455" width="200" height="45" class="keycloak-box"/>
  <text x="920" y="470" text-anchor="middle" class="text-bold">Query Filtering</text>
  <text x="920" y="485" text-anchor="middle" class="text-small">Automatic WHERE clause</text>
  <text x="920" y="497" text-anchor="middle" class="text-small">location = userCounty</text>

  <!-- DATA LAYER -->
  <rect x="50" y="530" width="1100" height="200" class="database-box" opacity="0.2"/>
  <text x="600" y="555" text-anchor="middle" class="section-title">Data Layer (PostgreSQL)</text>
  
  <!-- Repository Methods -->
  <rect x="100" y="575" width="250" height="70" class="database-box"/>
  <text x="225" y="595" text-anchor="middle" class="text-bold">Timesheet Repository</text>
  <text x="225" y="610" text-anchor="middle" class="text-small">countCreatedAfterWithFilters()</text>
  <text x="225" y="622" text-anchor="middle" class="text-small">countPendingApprovalsWithFilters()</text>
  <text x="225" y="634" text-anchor="middle" class="text-small">countDistinctEmployeesWithFilters()</text>
  <text x="225" y="646" text-anchor="middle" class="text-small">avgApprovalTimeHoursWithFilters()</text>

  <rect x="400" y="575" width="250" height="70" class="database-box"/>
  <text x="525" y="595" text-anchor="middle" class="text-bold">Demographic Queries</text>
  <text x="525" y="610" text-anchor="middle" class="text-small">countByProviderGender()</text>
  <text x="525" y="622" text-anchor="middle" class="text-small">countByRecipientGender()</text>
  <text x="525" y="634" text-anchor="middle" class="text-small">countByProviderEthnicity()</text>
  <text x="525" y="646" text-anchor="middle" class="text-small">countByProviderAgeGroup()</text>

  <rect x="700" y="575" width="250" height="70" class="database-box"/>
  <text x="825" y="595" text-anchor="middle" class="text-bold">Filter Queries</text>
  <text x="825" y="610" text-anchor="middle" class="text-small">findDistinctLocations()</text>
  <text x="825" y="622" text-anchor="middle" class="text-small">findDistinctDepartments()</text>
  <text x="825" y="634" text-anchor="middle" class="text-small">findDistinctStatuses()</text>
  <text x="825" y="646" text-anchor="middle" class="text-small">findDistinctGenders()</text>

  <rect x="100" y="665" width="250" height="55" class="database-box"/>
  <text x="225" y="685" text-anchor="middle" class="text-bold">Data Tables</text>
  <text x="225" y="700" text-anchor="middle" class="text-small">timesheets (main data)</text>
  <text x="225" y="712" text-anchor="middle" class="text-small">cases, persons (related data)</text>

  <rect x="400" y="665" width="250" height="55" class="database-box"/>
  <text x="525" y="685" text-anchor="middle" class="text-bold">Analytics Views</text>
  <text x="525" y="700" text-anchor="middle" class="text-small">Materialized views for performance</text>
  <text x="525" y="712" text-anchor="middle" class="text-small">Pre-aggregated metrics</text>

  <rect x="700" y="665" width="250" height="55" class="database-box"/>
  <text x="825" y="685" text-anchor="middle" class="text-bold">Query Optimization</text>
  <text x="825" y="700" text-anchor="middle" class="text-small">Indexed columns: location, status</text>
  <text x="825" y="712" text-anchor="middle" class="text-small">Date range filtering</text>

  <!-- DATA FLOW -->
  <rect x="50" y="740" width="1100" height="180" class="box" opacity="0.1"/>
  <text x="600" y="765" text-anchor="middle" class="section-title">Data Flow &amp; Processing</text>
  
  <!-- Step 1 -->
  <rect x="100" y="780" width="180" height="60" class="box"/>
  <text x="190" y="800" text-anchor="middle" class="text-bold">1. Client Request</text>
  <text x="190" y="815" text-anchor="middle" class="text-small">GET /api/analytics/realtime-metrics</text>
  <text x="190" y="827" text-anchor="middle" class="text-small">Query params: county, status, etc.</text>
  <text x="190" y="839" text-anchor="middle" class="text-small">JWT token in header</text>

  <!-- Step 2 -->
  <rect x="320" y="780" width="180" height="60" class="box"/>
  <text x="410" y="800" text-anchor="middle" class="text-bold">2. Security Check</text>
  <text x="410" y="815" text-anchor="middle" class="text-small">Validate JWT token</text>
  <text x="410" y="827" text-anchor="middle" class="text-small">Extract userRole, countyId</text>
  <text x="410" y="839" text-anchor="middle" class="text-small">Enforce county restrictions</text>

  <!-- Step 3 -->
  <rect x="540" y="780" width="180" height="60" class="box"/>
  <text x="630" y="800" text-anchor="middle" class="text-bold">3. Query Building</text>
  <text x="630" y="815" text-anchor="middle" class="text-small">Build SQL with filters</text>
  <text x="630" y="827" text-anchor="middle" class="text-small">Add county WHERE clause</text>
  <text x="630" y="839" text-anchor="middle" class="text-small">Date range, status filters</text>

  <!-- Step 4 -->
  <rect x="760" y="780" width="180" height="60" class="box"/>
  <text x="850" y="800" text-anchor="middle" class="text-bold">4. Data Retrieval</text>
  <text x="850" y="815" text-anchor="middle" class="text-small">Execute repository query</text>
  <text x="850" y="827" text-anchor="middle" class="text-small">Aggregate calculations</text>
  <text x="850" y="839" text-anchor="middle" class="text-small">Return result set</text>

  <!-- Step 5 -->
  <rect x="980" y="780" width="120" height="60" class="box"/>
  <text x="1040" y="800" text-anchor="middle" class="text-bold">5. Response</text>
  <text x="1040" y="815" text-anchor="middle" class="text-small">JSON format</text>
  <text x="1040" y="827" text-anchor="middle" class="text-small">Metrics object</text>
  <text x="1040" y="839" text-anchor="middle" class="text-small">lastUpdated timestamp</text>

  <!-- ARROWS -->
  <line x1="190" y1="170" x2="200" y2="230" class="arrow"/>
  <line x1="410" y1="170" x2="440" y2="230" class="arrow"/>
  <line x1="630" y1="170" x2="680" y2="230" class="arrow"/>
  <line x1="850" y1="170" x2="920" y2="230" class="arrow"/>
  
  <line x1="200" y1="300" x2="200" y2="455" class="arrow"/>
  <line x1="440" y1="300" x2="440" y2="455" class="arrow"/>
  <line x1="680" y1="300" x2="680" y2="455" class="arrow"/>
  <line x1="920" y1="300" x2="920" y2="455" class="arrow"/>
  
  <line x1="200" y1="500" x2="225" y2="575" class="arrow"/>
  <line x1="440" y1="500" x2="525" y2="575" class="arrow"/>
  <line x1="680" y1="500" x2="825" y2="575" class="arrow"/>
  
  <line x1="190" y1="840" x2="410" y2="840" class="arrow"/>
  <line x1="410" y1="840" x2="630" y2="840" class="arrow"/>
  <line x1="630" y1="840" x2="850" y2="840" class="arrow"/>
  <line x1="850" y1="840" x2="1040" y2="840" class="arrow"/>

  <!-- METRICS EXAMPLES -->
  <rect x="50" y="940" width="1100" height="120" class="box" opacity="0.1"/>
  <text x="600" y="965" text-anchor="middle" class="section-title">Example Metrics &amp; Response Format</text>
  
  <rect x="100" y="985" width="250" height="65" class="box"/>
  <text x="225" y="1005" text-anchor="middle" class="text-bold">Real-Time Metrics</text>
  <text x="225" y="1020" text-anchor="middle" class="text-small">totalTimesheetsToday: 1250</text>
  <text x="225" y="1032" text-anchor="middle" class="text-small">pendingApprovals: 45</text>
  <text x="225" y="1044" text-anchor="middle" class="text-small">avgApprovalTimeHours: 2.5</text>

  <rect x="400" y="985" width="250" height="65" class="box"/>
  <text x="525" y="1005" text-anchor="middle" class="text-bold">Demographics</text>
  <text x="525" y="1020" text-anchor="middle" class="text-small">provider: {Male: 450, Female: 380}</text>
  <text x="525" y="1032" text-anchor="middle" class="text-small">recipient: {Male: 320, Female: 280}</text>
  <text x="525" y="1044" text-anchor="middle" class="text-small">ageGroup: {18-25: 120, 26-35: 280}</text>

  <rect x="700" y="985" width="250" height="65" class="box"/>
  <text x="825" y="1005" text-anchor="middle" class="text-bold">County Metrics</text>
  <text x="825" y="1020" text-anchor="middle" class="text-small">counties: [{county: "Orange", providerCount: 150}]</text>
  <text x="825" y="1032" text-anchor="middle" class="text-small">totalMembers: 1250</text>
  <text x="825" y="1044" text-anchor="middle" class="text-small">totalProviders: 830</text>

  <!-- FEATURES -->
  <rect x="50" y="1080" width="1100" height="100" class="box" opacity="0.1"/>
  <text x="600" y="1105" text-anchor="middle" class="section-title">Key Features</text>
  
  <text x="100" y="1125" class="text-small">• Real-Time Data: Metrics updated in near real-time from database</text>
  <text x="100" y="1140" class="text-small">• County-Based Filtering: Automatic filtering by user's assigned county</text>
  <text x="100" y="1155" class="text-small">• Role-Based Access: Different data visibility based on user role</text>
  <text x="100" y="1170" class="text-small">• Flexible Filtering: Support for multiple filter parameters (date, status, location)</text>
  
  <text x="600" y="1125" class="text-small">• Demographic Analytics: Gender, ethnicity, and age group distributions</text>
  <text x="600" y="1140" class="text-small">• Ad-hoc Queries: Configurable reports with custom filters</text>
  <text x="600" y="1155" class="text-small">• Cross-Tabulation: Multi-dimensional data analysis</text>
  <text x="600" y="1170" class="text-small">• RESTful API: Standard HTTP methods, JSON responses</text>

</svg>

