<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2800 3000" style="background: #ffffff;">
  <!-- Title -->
  <text x="1400" y="50" font-family="Arial, sans-serif" font-size="42" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    Spring Boot Backend Architecture
  </text>
  <text x="1400" y="85" font-family="Arial, sans-serif" font-size="20" text-anchor="middle" fill="#666">
    CMIPS Application - Visual Service Flow &amp; Component Interaction
  </text>

  <!-- External Systems Layer -->
  <g id="external-layer">
    <!-- Frontend -->
    <rect x="100" y="120" width="280" height="100" fill="#3b82f6" stroke="#1e3a8a" stroke-width="3" rx="10"/>
    <text x="240" y="155" font-family="Arial" font-size="18" font-weight="bold" text-anchor="middle" fill="white">Frontend</text>
    <text x="240" y="180" font-family="Arial" font-size="14" text-anchor="middle" fill="white">Next.js</text>
    <text x="240" y="200" font-family="Arial" font-size="12" text-anchor="middle" fill="#dbeafe">Port 3000</text>
    
    <!-- Keycloak -->
    <rect x="420" y="120" width="280" height="100" fill="#ef4444" stroke="#991b1b" stroke-width="3" rx="10"/>
    <text x="560" y="155" font-family="Arial" font-size="18" font-weight="bold" text-anchor="middle" fill="white">Keycloak</text>
    <text x="560" y="180" font-family="Arial" font-size="14" text-anchor="middle" fill="white">IAM Server</text>
    <text x="560" y="200" font-family="Arial" font-size="12" text-anchor="middle" fill="#fee2e2">Port 8080</text>
    
    <!-- PostgreSQL -->
    <rect x="740" y="120" width="280" height="100" fill="#10b981" stroke="#065f46" stroke-width="3" rx="10"/>
    <text x="880" y="155" font-family="Arial" font-size="18" font-weight="bold" text-anchor="middle" fill="white">PostgreSQL</text>
    <text x="880" y="180" font-family="Arial" font-size="14" text-anchor="middle" fill="white">Database</text>
    <text x="880" y="200" font-family="Arial" font-size="12" text-anchor="middle" fill="#d1fae5">2 Schemas</text>
    
    <!-- Kafka -->
    <rect x="1060" y="120" width="280" height="100" fill="#f59e0b" stroke="#92400e" stroke-width="3" rx="10"/>
    <text x="1200" y="155" font-family="Arial" font-size="18" font-weight="bold" text-anchor="middle" fill="white">Apache Kafka</text>
    <text x="1200" y="180" font-family="Arial" font-size="14" text-anchor="middle" fill="white">Event Stream</text>
    <text x="1200" y="200" font-family="Arial" font-size="12" text-anchor="middle" fill="#fef3c7">+ Zookeeper</text>
    
    <!-- S3 Storage -->
    <rect x="1380" y="120" width="280" height="100" fill="#8b5cf6" stroke="#5b21b6" stroke-width="3" rx="10"/>
    <text x="1520" y="155" font-family="Arial" font-size="18" font-weight="bold" text-anchor="middle" fill="white">S3 Storage</text>
    <text x="1520" y="180" font-family="Arial" font-size="14" text-anchor="middle" fill="white">PDF Reports</text>
    <text x="1520" y="200" font-family="Arial" font-size="12" text-anchor="middle" fill="#e9d5ff">AWS</text>
  </g>

  <!-- Request Flow Arrows from Frontend -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#3b82f6" />
    </marker>
    <marker id="arrowhead-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#ef4444" />
    </marker>
    <marker id="arrowhead-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#10b981" />
    </marker>
    <marker id="arrowhead-orange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#f59e0b" />
    </marker>
    <marker id="arrowhead-purple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#8b5cf6" />
    </marker>
  </defs>

  <!-- Spring Boot Backend Container -->
  <rect x="100" y="280" width="2600" height="2660" fill="#f8fafc" stroke="#3b82f6" stroke-width="4" rx="15" stroke-dasharray="5,5"/>
  <text x="1400" y="310" font-family="Arial" font-size="24" font-weight="bold" text-anchor="middle" fill="#1e3a8a">Spring Boot Backend (Port 8081)</text>

  <!-- API Gateway / Entry Point -->
  <rect x="150" y="360" width="2500" height="80" fill="#dbeafe" stroke="#3b82f6" stroke-width="3" rx="8"/>
  <text x="1400" y="395" font-family="Arial" font-size="20" font-weight="bold" text-anchor="middle" fill="#1e3a8a">API Gateway / REST Controllers</text>
  <text x="1400" y="420" font-family="Arial" font-size="14" text-anchor="middle" fill="#1e40af">11 Controllers: Auth, KeycloakAdmin, ProviderRecipient, Task, Timesheet, Case, WorkQueue, EVV, Notification, GenericResource</text>

  <!-- Arrow from Frontend to API Gateway -->
  <line x1="240" y1="220" x2="1400" y2="360" stroke="#3b82f6" stroke-width="4" marker-end="url(#arrowhead)"/>
  <text x="800" y="280" font-family="Arial" font-size="12" fill="#3b82f6" font-weight="bold">HTTP/HTTPS Request</text>
  <text x="800" y="295" font-family="Arial" font-size="11" fill="#3b82f6">JWT Token in Header</text>

  <!-- Security Layer -->
  <rect x="150" y="480" width="2500" height="140" fill="#fee2e2" stroke="#ef4444" stroke-width="3" rx="8"/>
  <text x="1400" y="515" font-family="Arial" font-size="20" font-weight="bold" text-anchor="middle" fill="#991b1b">Security &amp; Authorization Layer</text>
  
  <!-- Security Components -->
  <rect x="200" y="540" width="350" height="60" fill="#fecaca" stroke="#ef4444" stroke-width="2" rx="6"/>
  <text x="375" y="565" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">JWT Token Validator</text>
  <text x="375" y="585" font-family="Arial" font-size="11" text-anchor="middle" fill="#7f1d1d">Extract &amp; Validate Token</text>
  
  <rect x="600" y="540" width="350" height="60" fill="#fecaca" stroke="#ef4444" stroke-width="2" rx="6"/>
  <text x="775" y="565" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">Keycloak Policy Evaluator</text>
  <text x="775" y="585" font-family="Arial" font-size="11" text-anchor="middle" fill="#7f1d1d">Permission Checks</text>
  
  <rect x="1000" y="540" width="350" height="60" fill="#fecaca" stroke="#ef4444" stroke-width="2" rx="6"/>
  <text x="1175" y="565" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">County Filter Injector</text>
  <text x="1175" y="585" font-family="Arial" font-size="11" text-anchor="middle" fill="#7f1d1d">User County Assignment</text>
  
  <rect x="1400" y="540" width="350" height="60" fill="#fecaca" stroke="#ef4444" stroke-width="2" rx="6"/>
  <text x="1575" y="565" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">Field Masking Service</text>
  <text x="1575" y="585" font-family="Arial" font-size="11" text-anchor="middle" fill="#7f1d1d">PII Protection</text>
  
  <rect x="1800" y="540" width="350" height="60" fill="#fecaca" stroke="#ef4444" stroke-width="2" rx="6"/>
  <text x="1975" y="565" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">Authorization Aspect</text>
  <text x="1975" y="585" font-family="Arial" font-size="11" text-anchor="middle" fill="#7f1d1d">@RequirePermission</text>
  
  <rect x="2200" y="540" width="350" height="60" fill="#fecaca" stroke="#ef4444" stroke-width="2" rx="6"/>
  <text x="2375" y="565" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">CORS Filter</text>
  <text x="2375" y="585" font-family="Arial" font-size="11" text-anchor="middle" fill="#7f1d1d">Cross-Origin</text>

  <!-- Arrows from API Gateway to Security -->
  <line x1="1400" y1="440" x2="1400" y2="540" stroke="#ef4444" stroke-width="3" marker-end="url(#arrowhead-red)"/>
  <text x="1450" y="495" font-family="Arial" font-size="11" fill="#991b1b" font-weight="bold">Security Check</text>

  <!-- Arrow from Security to Keycloak -->
  <line x1="560" y1="220" x2="775" y2="540" stroke="#ef4444" stroke-width="3" marker-end="url(#arrowhead-red)"/>
  <text x="500" y="380" font-family="Arial" font-size="11" fill="#991b1b" font-weight="bold">Token Validation</text>
  <line x1="775" y1="600" x2="560" y2="220" stroke="#ef4444" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead-red)"/>
  <text x="500" y="420" font-family="Arial" font-size="10" fill="#991b1b">Policy Response</text>

  <!-- Service Layer (Left Side) -->
  <rect x="150" y="660" width="1200" height="500" fill="#d1fae5" stroke="#10b981" stroke-width="3" rx="8"/>
  <text x="750" y="695" font-family="Arial" font-size="20" font-weight="bold" text-anchor="middle" fill="#065f46">Business Service Layer (11 Services)</text>
  
  <!-- Service Row 1 -->
  <rect x="200" y="720" width="280" height="100" fill="#a7f3d0" stroke="#10b981" stroke-width="2" rx="6"/>
  <text x="340" y="750" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">AuthService</text>
  <text x="340" y="770" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Login/Logout</text>
  <text x="340" y="790" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Token Management</text>
  <text x="340" y="810" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">User Info</text>
  
  <rect x="520" y="720" width="280" height="100" fill="#a7f3d0" stroke="#10b981" stroke-width="2" rx="6"/>
  <text x="660" y="750" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">KeycloakAdmin</text>
  <text x="660" y="770" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">User Management</text>
  <text x="660" y="790" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Role/Permission</text>
  <text x="660" y="810" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Feature Delegation</text>
  
  <rect x="840" y="720" width="280" height="100" fill="#a7f3d0" stroke="#10b981" stroke-width="2" rx="6"/>
  <text x="980" y="750" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">TimesheetService</text>
  <text x="980" y="770" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">CRUD Operations</text>
  <text x="980" y="790" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Approval Workflow</text>
  <text x="980" y="810" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">County Filter</text>
  
  <rect x="1160" y="720" width="280" height="100" fill="#a7f3d0" stroke="#10b981" stroke-width="2" rx="6"/>
  <text x="1300" y="750" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">TaskService</text>
  <text x="1300" y="770" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Task Management</text>
  <text x="1300" y="790" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Work Queue</text>
  <text x="1300" y="810" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Event Processing</text>
  
  <!-- Service Row 2 -->
  <rect x="200" y="850" width="280" height="100" fill="#a7f3d0" stroke="#10b981" stroke-width="2" rx="6"/>
  <text x="340" y="880" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">ProviderRecipient</text>
  <text x="340" y="900" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">User CRUD</text>
  <text x="340" y="920" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">County Assignment</text>
  <text x="340" y="940" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Filtering</text>
  
  <rect x="520" y="850" width="280" height="100" fill="#a7f3d0" stroke="#10b981" stroke-width="2" rx="6"/>
  <text x="660" y="880" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">EVVService</text>
  <text x="660" y="900" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Check-in/Check-out</text>
  <text x="660" y="920" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Location Tracking</text>
  <text x="660" y="940" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Compliance</text>
  
  <rect x="840" y="850" width="280" height="100" fill="#a7f3d0" stroke="#10b981" stroke-width="2" rx="6"/>
  <text x="980" y="880" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">CaseService</text>
  <text x="980" y="900" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Case Management</text>
  <text x="980" y="920" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Case Assignment</text>
  <text x="980" y="940" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Status Tracking</text>
  
  <rect x="1160" y="850" width="280" height="100" fill="#a7f3d0" stroke="#10b981" stroke-width="2" rx="6"/>
  <text x="1300" y="880" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">NotificationService</text>
  <text x="1300" y="900" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Email/SMS</text>
  <text x="1300" y="920" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">In-App Notifications</text>
  <text x="1300" y="940" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Push Notifications</text>
  
  <!-- Service Row 3 -->
  <rect x="200" y="980" width="280" height="100" fill="#a7f3d0" stroke="#10b981" stroke-width="2" rx="6"/>
  <text x="340" y="1010" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">WorkQueueService</text>
  <text x="340" y="1030" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Queue Catalog</text>
  <text x="340" y="1050" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Subscriptions</text>
  <text x="340" y="1070" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Task Routing</text>
  
  <rect x="520" y="980" width="280" height="100" fill="#a7f3d0" stroke="#10b981" stroke-width="2" rx="6"/>
  <text x="660" y="1010" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">ReportService</text>
  <text x="660" y="1030" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Report Generation</text>
  <text x="660" y="1050" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Data Aggregation</text>
  <text x="660" y="1070" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">PDF Export</text>
  
  <rect x="840" y="980" width="280" height="100" fill="#a7f3d0" stroke="#10b981" stroke-width="2" rx="6"/>
  <text x="980" y="1010" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">PDFGeneration</text>
  <text x="980" y="1030" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">PDF Templates</text>
  <text x="980" y="1050" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Batch Processing</text>
  <text x="980" y="1070" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">S3 Upload</text>
  
  <rect x="1160" y="980" width="280" height="100" fill="#a7f3d0" stroke="#10b981" stroke-width="2" rx="6"/>
  <text x="1300" y="1010" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">FieldMasking</text>
  <text x="1300" y="1030" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Field Visibility</text>
  <text x="1300" y="1050" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">PII Protection</text>
  <text x="1300" y="1070" font-family="Arial" font-size="11" text-anchor="middle" fill="#064e3b">Role-Based</text>

  <!-- Arrows from Security to Services -->
  <line x1="750" y1="600" x2="750" y2="720" stroke="#10b981" stroke-width="3" marker-end="url(#arrowhead-green)"/>
  <text x="800" y="665" font-family="Arial" font-size="11" fill="#065f46" font-weight="bold">Authorized Request</text>

  <!-- Repository Layer (Right Side) -->
  <rect x="1400" y="660" width="1200" height="500" fill="#fef3c7" stroke="#f59e0b" stroke-width="3" rx="8"/>
  <text x="2000" y="695" font-family="Arial" font-size="20" font-weight="bold" text-anchor="middle" fill="#92400e">Repository Layer (Data Access)</text>
  
  <!-- Repository Row 1 -->
  <rect x="1450" y="720" width="280" height="100" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="1590" y="750" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">UserRepository</text>
  <text x="1590" y="770" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Provider/Recipient</text>
  <text x="1590" y="790" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">County Filtering</text>
  <text x="1590" y="810" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Custom Queries</text>
  
  <rect x="1770" y="720" width="280" height="100" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="1910" y="750" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">TimesheetRepository</text>
  <text x="1910" y="770" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Timesheet CRUD</text>
  <text x="1910" y="790" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Status Queries</text>
  <text x="1910" y="810" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">County Filter</text>
  
  <rect x="2090" y="720" width="280" height="100" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="2230" y="750" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">TaskRepository</text>
  <text x="2230" y="770" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Task CRUD</text>
  <text x="2230" y="790" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Queue Queries</text>
  <text x="2230" y="810" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">User Tasks</text>
  
  <rect x="2410" y="720" width="280" height="100" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="2550" y="750" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">CaseRepository</text>
  <text x="2550" y="770" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Case CRUD</text>
  <text x="2550" y="790" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Assignment</text>
  <text x="2550" y="810" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">County Filter</text>
  
  <!-- Repository Row 2 -->
  <rect x="1450" y="850" width="280" height="100" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="1590" y="880" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">NotificationRepository</text>
  <text x="1590" y="900" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Notification CRUD</text>
  <text x="1590" y="920" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">User Notifications</text>
  <text x="1590" y="940" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Status Filter</text>
  
  <rect x="1770" y="850" width="280" height="100" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="1910" y="880" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">EVVRepository</text>
  <text x="1910" y="900" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">EVV Records</text>
  <text x="1910" y="920" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Location Data</text>
  <text x="1910" y="940" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Time Tracking</text>
  
  <rect x="2090" y="850" width="280" height="100" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="2230" y="880" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">WorkQueueRepository</text>
  <text x="2230" y="900" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Queue Subscriptions</text>
  <text x="2230" y="920" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">User Queues</text>
  <text x="2230" y="940" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Catalog Management</text>
  
  <rect x="2410" y="850" width="280" height="100" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="2550" y="880" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">ReportJobRepository</text>
  <text x="2550" y="900" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Job Status</text>
  <text x="2550" y="920" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Job Tracking</text>
  <text x="2550" y="940" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Progress Updates</text>
  
  <!-- Repository Row 3 -->
  <rect x="1450" y="980" width="280" height="100" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="1590" y="1010" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">JPA/Hibernate</text>
  <text x="1590" y="1030" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">ORM Framework</text>
  <text x="1590" y="1050" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Entity Mapping</text>
  <text x="1590" y="1070" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Query DSL</text>
  
  <rect x="1770" y="980" width="280" height="100" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="1910" y="1010" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">Spring Data JPA</text>
  <text x="1910" y="1030" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Repository Pattern</text>
  <text x="1910" y="1050" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Custom Queries</text>
  <text x="1910" y="1070" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Specifications</text>
  
  <rect x="2090" y="980" width="280" height="100" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="2230" y="1010" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">County Filtering</text>
  <text x="2230" y="1030" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Automatic WHERE</text>
  <text x="2230" y="1050" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">County IN Clause</text>
  <text x="2230" y="1070" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Query Optimization</text>
  
  <rect x="2410" y="980" width="280" height="100" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="2550" y="1010" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">Database Connection</text>
  <text x="2550" y="1030" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">JDBC Pool</text>
  <text x="2550" y="1050" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">HikariCP</text>
  <text x="2550" y="1070" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">Connection Mgmt</text>

  <!-- Arrows from Services to Repositories (Horizontal) -->
  <line x1="1350" y1="910" x2="1450" y2="910" stroke="#f59e0b" stroke-width="4" marker-end="url(#arrowhead-orange)"/>
  <text x="1400" y="900" font-family="Arial" font-size="12" fill="#92400e" font-weight="bold">Data Access</text>
  <text x="1400" y="920" font-family="Arial" font-size="11" fill="#92400e">Service → Repository</text>

  <!-- Database Connection -->
  <line x1="2000" y1="1160" x2="880" y2="220" stroke="#10b981" stroke-width="4" marker-end="url(#arrowhead-green)"/>
  <text x="1400" y="690" font-family="Arial" font-size="12" fill="#065f46" font-weight="bold">Database Query</text>
  <text x="1400" y="705" font-family="Arial" font-size="11" fill="#065f46">JDBC Connection</text>
  <line x1="880" y1="220" x2="2000" y2="1160" stroke="#10b981" stroke-width="3" stroke-dasharray="3,3" marker-end="url(#arrowhead-green)"/>
  <text x="1400" y="750" font-family="Arial" font-size="11" fill="#065f46">Query Results</text>

  <!-- Kafka Integration -->
  <rect x="150" y="1200" width="2500" height="200" fill="#fef3c7" stroke="#f59e0b" stroke-width="3" rx="8"/>
  <text x="1400" y="1475" font-family="Arial" font-size="20" font-weight="bold" text-anchor="middle" fill="#92400e">Event-Driven Communication (Kafka)</text>
  
  <!-- Kafka Producers -->
  <rect x="200" y="1260" width="500" height="120" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="450" y="1285" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">Event Producers</text>
  <text x="450" y="1305" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">TimesheetService → TimesheetEvent</text>
  <text x="450" y="1325" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">TaskService → TaskEvent</text>
  <text x="450" y="1345" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">CaseService → CaseEvent</text>
  <text x="450" y="1365" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">ReportService → ReportJobEvent</text>
  
  <!-- Kafka Topics -->
  <rect x="750" y="1260" width="500" height="120" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="1000" y="1285" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">Kafka Topics</text>
  <text x="1000" y="1305" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">timesheet-events</text>
  <text x="1000" y="1325" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">task-events</text>
  <text x="1000" y="1345" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">case-events</text>
  <text x="1000" y="1365" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">notification-events</text>
  
  <!-- Kafka Consumers -->
  <rect x="1300" y="1260" width="500" height="120" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="1550" y="1285" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">Event Consumers</text>
  <text x="1550" y="1305" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">TaskEventConsumer → TaskService</text>
  <text x="1550" y="1325" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">NotificationConsumer → NotificationService</text>
  <text x="1550" y="1345" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">ReportJobConsumer → ReportService</text>
  <text x="1550" y="1365" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Async Processing</text>
  
  <!-- Kafka Configuration -->
  <rect x="1850" y="1260" width="500" height="120" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="2100" y="1285" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">Kafka Config</text>
  <text x="2100" y="1305" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Producer Config</text>
  <text x="2100" y="1325" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Consumer Config</text>
  <text x="2100" y="1345" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Serialization</text>
  <text x="2100" y="1365" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Zookeeper Coordination</text>

  <!-- Arrows to Kafka -->
  <line x1="980" y1="1080" x2="1000" y2="1260" stroke="#f59e0b" stroke-width="3" marker-end="url(#arrowhead-orange)"/>
  <text x="990" y="1170" font-family="Arial" font-size="11" fill="#92400e" font-weight="bold">Publish Event</text>
  <line x1="1200" y1="220" x2="1000" y2="1260" stroke="#f59e0b" stroke-width="3" marker-end="url(#arrowhead-orange)"/>
  <text x="1050" y="740" font-family="Arial" font-size="11" fill="#92400e" font-weight="bold">Kafka Broker</text>
  <line x1="1000" y1="1380" x2="980" y2="1080" stroke="#f59e0b" stroke-width="3" stroke-dasharray="3,3" marker-end="url(#arrowhead-orange)"/>
  <text x="990" y="1230" font-family="Arial" font-size="11" fill="#92400e" font-weight="bold">Consume Event</text>

  <!-- Request Flow Diagram -->
  <rect x="150" y="1440" width="2500" height="400" fill="#e0e7ff" stroke="#6366f1" stroke-width="3" rx="8"/>
  <text x="1400" y="1715" font-family="Arial" font-size="20" font-weight="bold" text-anchor="middle" fill="#4338ca">Request Flow Diagram</text>
  
  <!-- Flow Steps -->
  <circle cx="300" cy="1540" r="50" fill="#6366f1" stroke="#4338ca" stroke-width="3"/>
  <text x="300" y="1545" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="white">1</text>
  <text x="300" y="1620" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#4338ca">Frontend</text>
  <text x="300" y="1640" font-family="Arial" font-size="12" text-anchor="middle" fill="#4338ca">HTTP Request</text>
  <text x="300" y="1660" font-family="Arial" font-size="12" text-anchor="middle" fill="#4338ca">JWT Token</text>
  
  <line x1="350" y1="1540" x2="550" y2="1540" stroke="#6366f1" stroke-width="4" marker-end="url(#arrowhead-purple)"/>
  
  <circle cx="600" cy="1540" r="50" fill="#6366f1" stroke="#4338ca" stroke-width="3"/>
  <text x="600" y="1545" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="white">2</text>
  <text x="600" y="1620" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#4338ca">Controller</text>
  <text x="600" y="1640" font-family="Arial" font-size="12" text-anchor="middle" fill="#4338ca">REST Endpoint</text>
  <text x="600" y="1660" font-family="Arial" font-size="12" text-anchor="middle" fill="#4338ca">Request Mapping</text>
  
  <line x1="650" y1="1540" x2="850" y2="1540" stroke="#6366f1" stroke-width="4" marker-end="url(#arrowhead-purple)"/>
  
  <circle cx="900" cy="1540" r="50" fill="#ef4444" stroke="#991b1b" stroke-width="3"/>
  <text x="900" y="1545" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="white">3</text>
  <text x="900" y="1620" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#991b1b">Security</text>
  <text x="900" y="1640" font-family="Arial" font-size="12" text-anchor="middle" fill="#991b1b">Token Validation</text>
  <text x="900" y="1660" font-family="Arial" font-size="12" text-anchor="middle" fill="#991b1b">Policy Check</text>
  
  <line x1="950" y1="1540" x2="1150" y2="1540" stroke="#6366f1" stroke-width="4" marker-end="url(#arrowhead-purple)"/>
  
  <circle cx="1200" cy="1540" r="50" fill="#10b981" stroke="#065f46" stroke-width="3"/>
  <text x="1200" y="1545" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="white">4</text>
  <text x="1200" y="1620" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">Service</text>
  <text x="1200" y="1640" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Business Logic</text>
  <text x="1200" y="1660" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">County Filter</text>
  
  <line x1="1250" y1="1540" x2="1450" y2="1540" stroke="#6366f1" stroke-width="4" marker-end="url(#arrowhead-purple)"/>
  
  <circle cx="1500" cy="1540" r="50" fill="#f59e0b" stroke="#92400e" stroke-width="3"/>
  <text x="1500" y="1545" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="white">5</text>
  <text x="1500" y="1620" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#92400e">Repository</text>
  <text x="1500" y="1640" font-family="Arial" font-size="12" text-anchor="middle" fill="#92400e">Database Query</text>
  <text x="1500" y="1660" font-family="Arial" font-size="12" text-anchor="middle" fill="#92400e">County WHERE</text>
  
  <line x1="1550" y1="1540" x2="1750" y2="1540" stroke="#6366f1" stroke-width="4" marker-end="url(#arrowhead-purple)"/>
  
  <circle cx="1800" cy="1540" r="50" fill="#10b981" stroke="#065f46" stroke-width="3"/>
  <text x="1800" y="1545" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="white">6</text>
  <text x="1800" y="1620" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">Database</text>
  <text x="1800" y="1640" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">PostgreSQL</text>
  <text x="1800" y="1660" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">2 Schemas</text>
  
  <!-- Return Flow -->
  <path d="M 1800 1590 L 1800 1760 L 300 1760 L 300 1590" stroke="#6366f1" stroke-width="4" fill="none" stroke-dasharray="5,5" marker-end="url(#arrowhead-purple)"/>
  <text x="1050" y="1780" font-family="Arial" font-size="12" fill="#4338ca" font-weight="bold">Response Flow: Data → Field Masking → JSON → Frontend</text>
  
  <!-- Event Flow -->
  <path d="M 1200 1590 L 1200 1710 L 1000 1710" stroke="#f59e0b" stroke-width="3" fill="none" stroke-dasharray="3,3" marker-end="url(#arrowhead-orange)"/>
  <text x="1100" y="1700" font-family="Arial" font-size="11" fill="#92400e" font-weight="bold">Event Publishing</text>

  <!-- County Filtering Flow -->
  <rect x="150" y="1880" width="2500" height="300" fill="#fef3c7" stroke="#f59e0b" stroke-width="3" rx="8"/>
  <text x="1400" y="2155" font-family="Arial" font-size="20" font-weight="bold" text-anchor="middle" fill="#92400e">County-Based Filtering Flow</text>
  
  <rect x="200" y="1940" width="400" height="200" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="400" y="1965" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">1. User Login</text>
  <text x="400" y="1990" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Keycloak Authentication</text>
  <text x="400" y="2010" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">JWT Token Issued</text>
  <text x="400" y="2030" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">User County Attributes</text>
  <text x="400" y="2050" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Extracted from Token</text>
  <text x="400" y="2070" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Multi-County Support</text>
  <text x="400" y="2090" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">County List Stored</text>
  <text x="400" y="2110" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">in Security Context</text>
  
  <line x1="600" y1="2040" x2="800" y2="2040" stroke="#f59e0b" stroke-width="3" marker-end="url(#arrowhead-orange)"/>
  
  <rect x="800" y="1940" width="400" height="200" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="1000" y="1965" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">2. Service Layer</text>
  <text x="1000" y="1990" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Service Method Called</text>
  <text x="1000" y="2010" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">County Filter Service</text>
  <text x="1000" y="2030" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Retrieves User Counties</text>
  <text x="1000" y="2050" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Builds Filter Criteria</text>
  <text x="1000" y="2070" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">WHERE county IN (...)</text>
  <text x="1000" y="2090" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Admin Override Check</text>
  <text x="1000" y="2110" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">No Filter if Admin</text>
  
  <line x1="1200" y1="2040" x2="1400" y2="2040" stroke="#f59e0b" stroke-width="3" marker-end="url(#arrowhead-orange)"/>
  
  <rect x="1400" y="1940" width="400" height="200" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="1600" y="1965" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">3. Repository Layer</text>
  <text x="1600" y="1990" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Repository Method Called</text>
  <text x="1600" y="2010" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">County Filter Applied</text>
  <text x="1600" y="2030" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">JPA Specification</text>
  <text x="1600" y="2050" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Query Modification</text>
  <text x="1600" y="2070" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">SQL WHERE Clause</text>
  <text x="1600" y="2090" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">County IN Condition</text>
  <text x="1600" y="2110" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Optimized Query</text>
  
  <line x1="1800" y1="2040" x2="2000" y2="2040" stroke="#f59e0b" stroke-width="3" marker-end="url(#arrowhead-orange)"/>
  
  <rect x="2000" y="1940" width="400" height="200" fill="#fde68a" stroke="#f59e0b" stroke-width="2" rx="6"/>
  <text x="2200" y="1965" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">4. Database Query</text>
  <text x="2200" y="1990" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">PostgreSQL Execution</text>
  <text x="2200" y="2010" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">County Index Used</text>
  <text x="2200" y="2030" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Filtered Results</text>
  <text x="2200" y="2050" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Only User Counties</text>
  <text x="2200" y="2070" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Performance Optimized</text>
  <text x="2200" y="2090" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Cached County Data</text>
  <text x="2200" y="2110" font-family="Arial" font-size="12" text-anchor="middle" fill="#78350f">Result Set Returned</text>

  <!-- Report Generation Flow -->
  <rect x="150" y="2220" width="2500" height="300" fill="#e9d5ff" stroke="#8b5cf6" stroke-width="3" rx="8"/>
  <text x="1400" y="2495" font-family="Arial" font-size="20" font-weight="bold" text-anchor="middle" fill="#5b21b6">Report Generation &amp; PDF Flow</text>
  
  <rect x="200" y="2280" width="450" height="200" fill="#ddd6fe" stroke="#8b5cf6" stroke-width="2" rx="6"/>
  <text x="425" y="2305" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#5b21b6">1. Report Request</text>
  <text x="425" y="2330" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Frontend Request</text>
  <text x="425" y="2350" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Report Type Selected</text>
  <text x="425" y="2370" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Date Range Filter</text>
  <text x="425" y="2390" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">County Filter Applied</text>
  <text x="425" y="2410" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Role-Based Access</text>
  <text x="425" y="2430" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Authorization Check</text>
  <text x="425" y="2450" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">ReportService Called</text>
  
  <line x1="650" y1="2380" x2="850" y2="2380" stroke="#8b5cf6" stroke-width="3" marker-end="url(#arrowhead-purple)"/>
  
  <rect x="850" y="2280" width="450" height="200" fill="#ddd6fe" stroke="#8b5cf6" stroke-width="2" rx="6"/>
  <text x="1075" y="2305" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#5b21b6">2. Data Aggregation</text>
  <text x="1075" y="2330" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Query Multiple Tables</text>
  <text x="1075" y="2350" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">County Filter Applied</text>
  <text x="1075" y="2370" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Join Operations</text>
  <text x="1075" y="2390" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Data Transformation</text>
  <text x="1075" y="2410" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Aggregation Functions</text>
  <text x="1075" y="2430" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Field Masking Applied</text>
  <text x="1075" y="2450" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Report Data Ready</text>
  
  <line x1="1300" y1="2380" x2="1500" y2="2380" stroke="#8b5cf6" stroke-width="3" marker-end="url(#arrowhead-purple)"/>
  
  <rect x="1500" y="2280" width="450" height="200" fill="#ddd6fe" stroke="#8b5cf6" stroke-width="2" rx="6"/>
  <text x="1725" y="2305" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#5b21b6">3. PDF Generation</text>
  <text x="1725" y="2330" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">PDF Template Selected</text>
  <text x="1725" y="2350" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Data Binding</text>
  <text x="1725" y="2370" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Chart Generation</text>
  <text x="1725" y="2390" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Multi-Page Layout</text>
  <text x="1725" y="2410" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Watermarking</text>
  <text x="1725" y="2430" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">PDF File Created</text>
  <text x="1725" y="2450" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Async Processing</text>
  
  <line x1="1950" y1="2380" x2="2150" y2="2380" stroke="#8b5cf6" stroke-width="3" marker-end="url(#arrowhead-purple)"/>
  
  <rect x="2150" y="2280" width="450" height="200" fill="#ddd6fe" stroke="#8b5cf6" stroke-width="2" rx="6"/>
  <text x="2375" y="2305" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#5b21b6">4. Storage &amp; Delivery</text>
  <text x="2375" y="2330" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Upload to S3</text>
  <text x="2375" y="2350" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Generate Download URL</text>
  <text x="2375" y="2370" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Email Notification</text>
  <text x="2375" y="2390" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Kafka Event Published</text>
  <text x="2375" y="2410" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Frontend Notification</text>
  <text x="2375" y="2430" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Download Link</text>
  <text x="2375" y="2450" font-family="Arial" font-size="12" text-anchor="middle" fill="#4c1d95">Response to User</text>

  <!-- Arrow to S3 -->
  <line x1="2375" y1="2280" x2="1520" y2="220" stroke="#8b5cf6" stroke-width="3" stroke-dasharray="5,5" marker-end="url(#arrowhead-purple)"/>
  <text x="1900" y="1250" font-family="Arial" font-size="11" fill="#5b21b6" font-weight="bold">S3 Upload</text>

  <!-- Configuration Layer -->
  <rect x="150" y="2560" width="2500" height="250" fill="#f0fdf4" stroke="#22c55e" stroke-width="3" rx="8"/>
  <text x="1400" y="2835" font-family="Arial" font-size="20" font-weight="bold" text-anchor="middle" fill="#15803d">Configuration &amp; Infrastructure</text>
  
  <rect x="200" y="2620" width="500" height="160" fill="#dcfce7" stroke="#22c55e" stroke-width="2" rx="6"/>
  <text x="450" y="2645" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#15803d">Spring Configuration</text>
  <text x="450" y="2670" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">SecurityConfig: JWT, Keycloak, CORS</text>
  <text x="450" y="2690" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">KafkaConfig: Producer/Consumer</text>
  <text x="450" y="2710" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">DataSourceConfig: PostgreSQL, HikariCP</text>
  <text x="450" y="2730" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">AOPConfig: AuthorizationAspect</text>
  <text x="450" y="2750" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Application Properties</text>
  
  <rect x="750" y="2620" width="500" height="160" fill="#dcfce7" stroke="#22c55e" stroke-width="2" rx="6"/>
  <text x="1000" y="2645" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#15803d">Docker Configuration</text>
  <text x="1000" y="2670" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Dockerfile: Multi-stage Build</text>
  <text x="1000" y="2690" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">docker-compose.yml: Services</text>
  <text x="1000" y="2710" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Environment Variables</text>
  <text x="1000" y="2730" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Network Configuration</text>
  <text x="1000" y="2750" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Health Checks</text>
  
  <rect x="1300" y="2620" width="500" height="160" fill="#dcfce7" stroke="#22c55e" stroke-width="2" rx="6"/>
  <text x="1550" y="2645" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#15803d">Database Schema</text>
  <text x="1550" y="2670" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Keycloak Schema: Users, Roles, Policies</text>
  <text x="1550" y="2690" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Application Schema: Business Data</text>
  <text x="1550" y="2710" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">JPA Entities: Domain Models</text>
  <text x="1550" y="2730" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Migrations: Flyway/Liquibase</text>
  <text x="1550" y="2750" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Indexes: Performance Optimization</text>
  
  <rect x="1850" y="2620" width="500" height="160" fill="#dcfce7" stroke="#22c55e" stroke-width="2" rx="6"/>
  <text x="2100" y="2645" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#15803d">Monitoring &amp; Logging</text>
  <text x="2100" y="2670" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Structured Logging: SLF4J/Logback</text>
  <text x="2100" y="2690" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Metrics: Actuator Endpoints</text>
  <text x="2100" y="2710" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Health Checks: /actuator/health</text>
  <text x="2100" y="2730" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Request Tracing: Correlation IDs</text>
  <text x="2100" y="2750" font-family="Arial" font-size="12" text-anchor="middle" fill="#065f46">Error Handling: Global Exception</text>

  <!-- Summary Box -->
  <rect x="150" y="2860" width="2500" height="80" fill="#1e3a8a" stroke="#1e40af" stroke-width="4" rx="10"/>
  <text x="1400" y="2895" font-family="Arial" font-size="22" font-weight="bold" text-anchor="middle" fill="white">Spring Boot Backend Architecture Summary</text>
  <text x="1400" y="2920" font-family="Arial" font-size="14" text-anchor="middle" fill="#dbeafe">11 Controllers | 11 Services | Repository Pattern | Dual Authentication | County-Based Filtering | Event-Driven (Kafka) | PDF Generation | Field Masking</text>
</svg>
