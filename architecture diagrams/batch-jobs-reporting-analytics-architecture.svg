<svg width="1400" height="2000" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font-family: Arial, sans-serif; font-size: 24px; font-weight: bold; fill: #1a1a1a; }
      .section-title { font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; fill: #2c3e50; }
      .box { fill: #ecf0f1; stroke: #34495e; stroke-width: 2; rx: 5; }
      .service-box { fill: #e8f5e9; stroke: #2e7d32; stroke-width: 2; rx: 5; }
      .controller-box { fill: #e3f2fd; stroke: #1565c0; stroke-width: 2; rx: 5; }
      .scheduler-box { fill: #fff3e0; stroke: #e65100; stroke-width: 2; rx: 5; }
      .database-box { fill: #f3e5f5; stroke: #6a1b9a; stroke-width: 2; rx: 5; }
      .keycloak-box { fill: #e0f2f1; stroke: #00695c; stroke-width: 2; rx: 5; }
      .pipeline-box { fill: #fff9c4; stroke: #f57f17; stroke-width: 2; rx: 5; }
      .delivery-box { fill: #fce4ec; stroke: #c2185b; stroke-width: 2; rx: 5; }
      .text { font-family: Arial, sans-serif; font-size: 12px; fill: #2c3e50; }
      .text-small { font-family: Arial, sans-serif; font-size: 10px; fill: #555; }
      .arrow { stroke: #34495e; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-dashed { stroke: #7f8c8d; stroke-width: 1.5; fill: none; stroke-dasharray: 5,5; marker-end: url(#arrowhead); }
      .label { font-family: Arial, sans-serif; font-size: 10px; fill: #555; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#34495e" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="700" y="30" text-anchor="middle" class="title">Batch Jobs, Reporting &amp; Analytics Architecture</text>
  <text x="700" y="50" text-anchor="middle" class="text-small">IHSS Pipeline Master - Complete System Architecture</text>

  <!-- SCHEDULER LAYER -->
  <rect x="50" y="80" width="1300" height="100" class="scheduler-box" opacity="0.3"/>
  <text x="700" y="105" text-anchor="middle" class="section-title">Scheduler Layer</text>
  
  <rect x="100" y="120" width="180" height="50" class="scheduler-box"/>
  <text x="190" y="140" text-anchor="middle" class="text" font-weight="bold">Batch Job Scheduler</text>
  <text x="190" y="155" text-anchor="middle" class="text-small">@Scheduled (5s interval)</text>
  <text x="190" y="168" text-anchor="middle" class="text-small">Polls QUEUED jobs</text>

  <rect x="320" y="120" width="200" height="50" class="scheduler-box"/>
  <text x="420" y="140" text-anchor="middle" class="text" font-weight="bold">Scheduled Report Service</text>
  <text x="420" y="155" text-anchor="middle" class="text-small">Daily/Weekly/Monthly Cron</text>
  <text x="420" y="168" text-anchor="middle" class="text-small">Generates JWT tokens</text>

  <rect x="560" y="120" width="180" height="50" class="scheduler-box"/>
  <text x="650" y="140" text-anchor="middle" class="text" font-weight="bold">System Scheduler</text>
  <text x="650" y="155" text-anchor="middle" class="text-small">County-specific reports</text>
  <text x="650" y="168" text-anchor="middle" class="text-small">Every 2 minutes (test)</text>

  <rect x="780" y="120" width="180" height="50" class="scheduler-box"/>
  <text x="870" y="140" text-anchor="middle" class="text" font-weight="bold">Job Dependency Service</text>
  <text x="870" y="155" text-anchor="middle" class="text-small">Triggers dependent jobs</text>
  <text x="870" y="168" text-anchor="middle" class="text-small">ON_SUCCESS condition</text>

  <rect x="1000" y="120" width="280" height="50" class="keycloak-box"/>
  <text x="1140" y="140" text-anchor="middle" class="text" font-weight="bold">Keycloak (JWT Token Generation)</text>
  <text x="1140" y="155" text-anchor="middle" class="text-small">Service account credentials</text>
  <text x="1140" y="168" text-anchor="middle" class="text-small">Role-based token exchange</text>

  <!-- API LAYER -->
  <rect x="50" y="200" width="1300" height="120" class="controller-box" opacity="0.3"/>
  <text x="700" y="225" text-anchor="middle" class="section-title">API Layer (REST Controllers)</text>
  
  <rect x="100" y="240" width="200" height="70" class="controller-box"/>
  <text x="200" y="260" text-anchor="middle" class="text" font-weight="bold">Business Intelligence</text>
  <text x="200" y="275" text-anchor="middle" class="text" font-weight="bold">Controller</text>
  <text x="200" y="290" text-anchor="middle" class="text-small">POST /api/bi/reports/generate</text>
  <text x="200" y="303" text-anchor="middle" class="text-small">GET /api/bi/jobs/{id}/status</text>

  <rect x="340" y="240" width="200" height="70" class="controller-box"/>
  <text x="440" y="260" text-anchor="middle" class="text" font-weight="bold">Analytics Controller</text>
  <text x="440" y="275" text-anchor="middle" class="text" font-weight="bold">(Real-time Metrics)</text>
  <text x="440" y="290" text-anchor="middle" class="text-small">GET /api/analytics/realtime-metrics</text>
  <text x="440" y="303" text-anchor="middle" class="text-small">GET /api/analytics/adhoc-data</text>

  <rect x="580" y="240" width="200" height="70" class="controller-box"/>
  <text x="680" y="260" text-anchor="middle" class="text" font-weight="bold">Data Pipeline</text>
  <text x="680" y="275" text-anchor="middle" class="text" font-weight="bold">Controller</text>
  <text x="680" y="290" text-anchor="middle" class="text-small">POST /api/pipeline/extract</text>
  <text x="680" y="303" text-anchor="middle" class="text-small">Data extraction endpoints</text>

  <rect x="820" y="240" width="200" height="70" class="controller-box"/>
  <text x="920" y="260" text-anchor="middle" class="text" font-weight="bold">Report Delivery</text>
  <text x="920" y="275" text-anchor="middle" class="text" font-weight="bold">Controller</text>
  <text x="920" y="290" text-anchor="middle" class="text-small">GET /api/reports/download</text>
  <text x="920" y="303" text-anchor="middle" class="text-small">Report file downloads</text>

  <rect x="1060" y="240" width="200" height="70" class="controller-box"/>
  <text x="1160" y="260" text-anchor="middle" class="text" font-weight="bold">Field Masking</text>
  <text x="1160" y="275" text-anchor="middle" class="text" font-weight="bold">Controller</text>
  <text x="1160" y="290" text-anchor="middle" class="text-small">GET /api/field-masking/config</text>
  <text x="1160" y="303" text-anchor="middle" class="text-small">Role-based field visibility</text>

  <!-- SERVICE LAYER -->
  <rect x="50" y="340" width="1300" height="280" class="service-box" opacity="0.3"/>
  <text x="700" y="365" text-anchor="middle" class="section-title">Service Layer (Business Logic)</text>
  
  <!-- Row 1: Core Services -->
  <rect x="100" y="380" width="200" height="70" class="service-box"/>
  <text x="200" y="400" text-anchor="middle" class="text" font-weight="bold">Job Queue Service</text>
  <text x="200" y="415" text-anchor="middle" class="text-small">queueReportJob()</text>
  <text x="200" y="428" text-anchor="middle" class="text-small">getJobStatus()</text>
  <text x="200" y="441" text-anchor="middle" class="text-small">markJobAsProcessing()</text>

  <rect x="340" y="380" width="200" height="70" class="service-box"/>
  <text x="440" y="400" text-anchor="middle" class="text" font-weight="bold">Background Processing</text>
  <text x="440" y="415" text-anchor="middle" class="text" font-weight="bold">Service</text>
  <text x="440" y="428" text-anchor="middle" class="text-small">processJob() - Async</text>
  <text x="440" y="441" text-anchor="middle" class="text-small">Chunked data processing</text>

  <rect x="580" y="380" width="200" height="70" class="service-box"/>
  <text x="680" y="400" text-anchor="middle" class="text" font-weight="bold">Report Generation</text>
  <text x="680" y="415" text-anchor="middle" class="text" font-weight="bold">Service</text>
  <text x="680" y="428" text-anchor="middle" class="text-small">5-Stage Pipeline</text>
  <text x="680" y="441" text-anchor="middle" class="text-small">JWT-based masking</text>

  <rect x="820" y="380" width="200" height="70" class="service-box"/>
  <text x="920" y="400" text-anchor="middle" class="text" font-weight="bold">Data Fetching</text>
  <text x="920" y="415" text-anchor="middle" class="text" font-weight="bold">Service</text>
  <text x="920" y="428" text-anchor="middle" class="text-small">fetchData() with pagination</text>
  <text x="920" y="441" text-anchor="middle" class="text-small">County-based filtering</text>

  <rect x="1060" y="380" width="200" height="70" class="service-box"/>
  <text x="1160" y="400" text-anchor="middle" class="text" font-weight="bold">Query Builder</text>
  <text x="1160" y="415" text-anchor="middle" class="text" font-weight="bold">Service</text>
  <text x="1160" y="428" text-anchor="middle" class="text-small">buildQuery()</text>
  <text x="1160" y="441" text-anchor="middle" class="text-small">Role-based SQL generation</text>

  <!-- Row 2: Security & Processing Services -->
  <rect x="100" y="470" width="200" height="70" class="service-box"/>
  <text x="200" y="490" text-anchor="middle" class="text" font-weight="bold">Field Masking</text>
  <text x="200" y="505" text-anchor="middle" class="text" font-weight="bold">Service</text>
  <text x="200" y="518" text-anchor="middle" class="text-small">applyFieldMasking()</text>
  <text x="200" y="531" text-anchor="middle" class="text-small">Keycloak JWT-based</text>

  <rect x="340" y="470" width="200" height="70" class="service-box"/>
  <text x="440" y="490" text-anchor="middle" class="text" font-weight="bold">Field Visibility</text>
  <text x="440" y="505" text-anchor="middle" class="text" font-weight="bold">Service</text>
  <text x="440" y="518" text-anchor="middle" class="text-small">getVisibleFields(role)</text>
  <text x="440" y="531" text-anchor="middle" class="text-small">Role-based field config</text>

  <rect x="580" y="470" width="200" height="70" class="service-box"/>
  <text x="680" y="490" text-anchor="middle" class="text" font-weight="bold">Rules Engine</text>
  <text x="680" y="505" text-anchor="middle" class="text" font-weight="bold">Service</text>
  <text x="680" y="518" text-anchor="middle" class="text-small">Business rules validation</text>
  <text x="680" y="531" text-anchor="middle" class="text-small">Data quality checks</text>

  <rect x="820" y="470" width="200" height="70" class="service-box"/>
  <text x="920" y="490" text-anchor="middle" class="text" font-weight="bold">County Mapping</text>
  <text x="920" y="505" text-anchor="middle" class="text" font-weight="bold">Service</text>
  <text x="920" y="518" text-anchor="middle" class="text-small">County code mapping</text>
  <text x="920" y="531" text-anchor="middle" class="text-small">CT1-CT5 to names</text>

  <rect x="1060" y="470" width="200" height="70" class="service-box"/>
  <text x="1160" y="490" text-anchor="middle" class="text" font-weight="bold">Keycloak User</text>
  <text x="1160" y="505" text-anchor="middle" class="text" font-weight="bold">Service</text>
  <text x="1160" y="518" text-anchor="middle" class="text-small">User info extraction</text>
  <text x="1160" y="531" text-anchor="middle" class="text-small">JWT token parsing</text>

  <!-- Row 3: Report Generators -->
  <rect x="100" y="560" width="200" height="50" class="service-box"/>
  <text x="200" y="580" text-anchor="middle" class="text" font-weight="bold">PDF Report Generator</text>
  <text x="200" y="595" text-anchor="middle" class="text-small">FreeMarker templates</text>

  <rect x="340" y="560" width="200" height="50" class="service-box"/>
  <text x="440" y="580" text-anchor="middle" class="text" font-weight="bold">CSV Report Generator</text>
  <text x="440" y="595" text-anchor="middle" class="text-small">Streaming CSV output</text>

  <rect x="580" y="560" width="200" height="50" class="service-box"/>
  <text x="680" y="580" text-anchor="middle" class="text" font-weight="bold">Report Template</text>
  <text x="680" y="595" text-anchor="middle" class="text" font-weight="bold">Service</text>

  <rect x="820" y="560" width="200" height="50" class="service-box"/>
  <text x="920" y="580" text-anchor="middle" class="text" font-weight="bold">Event Service</text>
  <text x="920" y="595" text-anchor="middle" class="text-small">Audit logging</text>

  <rect x="1060" y="560" width="200" height="50" class="service-box"/>
  <text x="1160" y="580" text-anchor="middle" class="text" font-weight="bold">Notification Service</text>
  <text x="1160" y="595" text-anchor="middle" class="text-small">Email/SMS/Webhook</text>

  <!-- 5-STAGE PIPELINE -->
  <rect x="50" y="640" width="1300" height="120" class="pipeline-box" opacity="0.3"/>
  <text x="700" y="665" text-anchor="middle" class="section-title">5-Stage Report Generation Pipeline</text>
  
  <rect x="100" y="680" width="220" height="70" class="pipeline-box"/>
  <text x="210" y="700" text-anchor="middle" class="text" font-weight="bold">Stage 1: Parameter Extraction</text>
  <text x="210" y="715" text-anchor="middle" class="text-small">Extract userRole, countyId</text>
  <text x="210" y="728" text-anchor="middle" class="text-small">from JWT token</text>
  <text x="210" y="741" text-anchor="middle" class="text-small">Validate user permissions</text>

  <rect x="360" y="680" width="220" height="70" class="pipeline-box"/>
  <text x="470" y="700" text-anchor="middle" class="text" font-weight="bold">Stage 2: Query Building</text>
  <text x="470" y="715" text-anchor="middle" class="text-small">Build SQL query with</text>
  <text x="470" y="728" text-anchor="middle" class="text-small">county filters, date range</text>
  <text x="470" y="741" text-anchor="middle" class="text-small">Role-based access control</text>

  <rect x="620" y="680" width="220" height="70" class="pipeline-box"/>
  <text x="730" y="700" text-anchor="middle" class="text" font-weight="bold">Stage 3: Data Fetching</text>
  <text x="730" y="715" text-anchor="middle" class="text-small">Execute query with pagination</text>
  <text x="730" y="728" text-anchor="middle" class="text-small">Chunk size: 1000 records</text>
  <text x="730" y="741" text-anchor="middle" class="text-small">Return TimesheetEntity list</text>

  <rect x="880" y="680" width="220" height="70" class="pipeline-box"/>
  <text x="990" y="700" text-anchor="middle" class="text" font-weight="bold">Stage 4: Field Masking</text>
  <text x="990" y="715" text-anchor="middle" class="text-small">Apply role-based masking</text>
  <text x="990" y="728" text-anchor="middle" class="text-small">Keycloak JWT-based rules</text>
  <text x="990" y="741" text-anchor="middle" class="text-small">Return MaskedTimesheetData</text>

  <rect x="1140" y="680" width="180" height="70" class="pipeline-box"/>
  <text x="1230" y="700" text-anchor="middle" class="text" font-weight="bold">Stage 5: Report Generation</text>
  <text x="1230" y="715" text-anchor="middle" class="text-small">Convert to report format</text>
  <text x="1230" y="728" text-anchor="middle" class="text-small">JSON/CSV/PDF/XML</text>
  <text x="1230" y="741" text-anchor="middle" class="text-small">Stream to file</text>

  <!-- DELIVERY LAYER -->
  <rect x="50" y="780" width="1300" height="100" class="delivery-box" opacity="0.3"/>
  <text x="700" y="805" text-anchor="middle" class="section-title">Delivery Layer</text>
  
  <rect x="100" y="820" width="200" height="50" class="delivery-box"/>
  <text x="200" y="840" text-anchor="middle" class="text" font-weight="bold">Email Report Service</text>
  <text x="200" y="855" text-anchor="middle" class="text-small">PDF attachments</text>

  <rect x="340" y="820" width="200" height="50" class="delivery-box"/>
  <text x="440" y="840" text-anchor="middle" class="text" font-weight="bold">SFTP Delivery Service</text>
  <text x="440" y="855" text-anchor="middle" class="text-small">Encrypted file transfer</text>

  <rect x="580" y="820" width="200" height="50" class="delivery-box"/>
  <text x="680" y="840" text-anchor="middle" class="text" font-weight="bold">Encryption Service</text>
  <text x="680" y="855" text-anchor="middle" class="text-small">AES-256 encryption</text>

  <rect x="820" y="820" width="200" height="50" class="delivery-box"/>
  <text x="920" y="840" text-anchor="middle" class="text" font-weight="bold">File Storage</text>
  <text x="920" y="855" text-anchor="middle" class="text-small">./reports/ directory</text>

  <rect x="1060" y="820" width="200" height="50" class="delivery-box"/>
  <text x="1160" y="840" text-anchor="middle" class="text" font-weight="bold">Notification Service</text>
  <text x="1160" y="855" text-anchor="middle" class="text-small">Job completion alerts</text>

  <!-- DATA LAYER -->
  <rect x="50" y="900" width="1300" height="100" class="database-box" opacity="0.3"/>
  <text x="700" y="925" text-anchor="middle" class="section-title">Data Layer</text>
  
  <rect x="100" y="940" width="280" height="50" class="database-box"/>
  <text x="240" y="960" text-anchor="middle" class="text" font-weight="bold">PostgreSQL Database</text>
  <text x="240" y="975" text-anchor="middle" class="text-small">report_jobs, timesheets, cases, persons</text>

  <rect x="420" y="940" width="200" height="50" class="database-box"/>
  <text x="520" y="960" text-anchor="middle" class="text" font-weight="bold">Report Job Repository</text>
  <text x="520" y="975" text-anchor="middle" class="text-small">JPA/Hibernate</text>

  <rect x="660" y="940" width="200" height="50" class="database-box"/>
  <text x="760" y="960" text-anchor="middle" class="text" font-weight="bold">Timesheet Repository</text>
  <text x="760" y="975" text-anchor="middle" class="text-small">Custom queries</text>

  <rect x="900" y="940" width="200" height="50" class="database-box"/>
  <text x="1000" y="960" text-anchor="middle" class="text" font-weight="bold">Case Repository</text>
  <text x="1000" y="975" text-anchor="middle" class="text-small">Person Repository</text>

  <rect x="1140" y="940" width="200" height="50" class="database-box"/>
  <text x="1240" y="960" text-anchor="middle" class="text" font-weight="bold">Analytics Views</text>
  <text x="1240" y="975" text-anchor="middle" class="text-small">Materialized views</text>

  <!-- ARROWS: Scheduler to Service -->
  <line x1="190" y1="170" x2="200" y2="380" class="arrow"/>
  <text x="195" y="280" class="label">Polls QUEUED</text>
  
  <line x1="420" y1="170" x2="200" y2="380" class="arrow"/>
  <text x="310" y="280" class="label">Creates jobs</text>
  
  <line x1="650" y1="170" x2="200" y2="380" class="arrow"/>
  <text x="425" y="280" class="label">County reports</text>
  
  <line x1="870" y1="170" x2="440" y2="380" class="arrow-dashed"/>
  <text x="655" y="280" class="label">Triggers deps</text>

  <!-- ARROWS: API to Service -->
  <line x1="200" y1="310" x2="200" y2="380" class="arrow"/>
  <line x1="440" y1="310" x2="680" y2="380" class="arrow"/>
  <line x1="920" y1="310" x2="1060" y2="380" class="arrow"/>

  <!-- ARROWS: Service to Pipeline -->
  <line x1="440" y1="450" x2="210" y2="680" class="arrow"/>
  <text x="325" y="570" class="label">Starts pipeline</text>
  
  <line x1="210" y1="750" x2="470" y2="680" class="arrow"/>
  <line x1="470" y1="750" x2="730" y2="680" class="arrow"/>
  <line x1="730" y1="750" x2="990" y2="680" class="arrow"/>
  <line x1="990" y1="750" x2="1230" y2="680" class="arrow"/>

  <!-- ARROWS: Pipeline to Delivery -->
  <line x1="1230" y1="750" x2="200" y2="820" class="arrow"/>
  <line x1="1230" y1="750" x2="440" y2="820" class="arrow"/>
  <line x1="1230" y1="750" x2="680" y2="820" class="arrow"/>

  <!-- ARROWS: Service to Data -->
  <line x1="920" y1="450" x2="240" y2="940" class="arrow"/>
  <line x1="1160" y1="450" x2="520" y2="940" class="arrow"/>
  <line x1="200" y1="450" x2="520" y2="940" class="arrow"/>

  <!-- ARROWS: Keycloak -->
  <line x1="1140" y1="170" x2="1160" y2="380" class="arrow-dashed"/>
  <text x="1150" y="280" class="label">JWT tokens</text>
  
  <line x1="1140" y1="170" x2="200" y2="470" class="arrow-dashed"/>
  <text x="670" y="320" class="label">Field masking</text>

  <!-- CONFIGURATION BOXES -->
  <rect x="50" y="1030" width="1300" height="120" class="box" opacity="0.2"/>
  <text x="700" y="1055" text-anchor="middle" class="section-title">Configuration &amp; Properties</text>
  
  <rect x="100" y="1070" width="200" height="70" class="box"/>
  <text x="200" y="1090" text-anchor="middle" class="text" font-weight="bold">Batch Scheduler</text>
  <text x="200" y="1105" text-anchor="middle" class="text" font-weight="bold">Properties</text>
  <text x="200" y="1120" text-anchor="middle" class="text-small">interval-ms: 5000</text>
  <text x="200" y="1133" text-anchor="middle" class="text-small">max-jobs-per-poll: 3</text>

  <rect x="340" y="1070" width="200" height="70" class="box"/>
  <text x="440" y="1090" text-anchor="middle" class="text" font-weight="bold">Job Processing</text>
  <text x="440" y="1105" text-anchor="middle" class="text" font-weight="bold">Properties</text>
  <text x="440" y="1120" text-anchor="middle" class="text-small">chunk-size: 1000</text>
  <text x="440" y="1133" text-anchor="middle" class="text-small">worker-pool-size: 2</text>

  <rect x="580" y="1070" width="200" height="70" class="box"/>
  <text x="680" y="1090" text-anchor="middle" class="text" font-weight="bold">Report Scheduling</text>
  <text x="680" y="1105" text-anchor="middle" class="text" font-weight="bold">Properties</text>
  <text x="680" y="1120" text-anchor="middle" class="text-small">daily-cron: 0 30 5 * * ?</text>
  <text x="680" y="1133" text-anchor="middle" class="text-small">weekly-cron: 0 30 5 * * MON</text>

  <rect x="820" y="1070" width="200" height="70" class="box"/>
  <text x="920" y="1090" text-anchor="middle" class="text" font-weight="bold">Job Dependencies</text>
  <text x="920" y="1105" text-anchor="middle" class="text" font-weight="bold">Config</text>
  <text x="920" y="1120" text-anchor="middle" class="text-small">parent-report-type</text>
  <text x="920" y="1133" text-anchor="middle" class="text-small">dependent-report-type</text>

  <rect x="1060" y="1070" width="200" height="70" class="box"/>
  <text x="1160" y="1090" text-anchor="middle" class="text" font-weight="bold">Keycloak Config</text>
  <text x="1160" y="1105" text-anchor="middle" class="text" font-weight="bold">Service Accounts</text>
  <text x="1160" y="1120" text-anchor="middle" class="text-small">cron_admin, cron_supervisor</text>
  <text x="1160" y="1133" text-anchor="middle" class="text-small">cron_case_worker</text>

  <!-- EXTERNAL SYSTEMS -->
  <rect x="50" y="1180" width="1300" height="100" class="box" opacity="0.2"/>
  <text x="700" y="1205" text-anchor="middle" class="section-title">External Systems &amp; Integrations</text>
  
  <rect x="100" y="1220" width="180" height="50" class="box"/>
  <text x="190" y="1240" text-anchor="middle" class="text" font-weight="bold">SMTP Server</text>
  <text x="190" y="1255" text-anchor="middle" class="text-small">Email delivery</text>

  <rect x="320" y="1220" width="180" height="50" class="box"/>
  <text x="410" y="1240" text-anchor="middle" class="text" font-weight="bold">SFTP Server</text>
  <text x="410" y="1255" text-anchor="middle" class="text-small">File transfer</text>

  <rect x="540" y="1220" width="180" height="50" class="box"/>
  <text x="630" y="1240" text-anchor="middle" class="text" font-weight="bold">Tableau</text>
  <text x="630" y="1255" text-anchor="middle" class="text-small">BI Analytics</text>

  <rect x="760" y="1220" width="180" height="50" class="box"/>
  <text x="850" y="1240" text-anchor="middle" class="text" font-weight="bold">Power BI</text>
  <text x="850" y="1255" text-anchor="middle" class="text-small">Business Intelligence</text>

  <rect x="980" y="1220" width="180" height="50" class="box"/>
  <text x="1070" y="1240" text-anchor="middle" class="text" font-weight="bold">Notification Service</text>
  <text x="1070" y="1255" text-anchor="middle" class="text-small">Separate microservice</text>

  <rect x="1200" y="1220" width="180" height="50" class="box"/>
  <text x="1290" y="1240" text-anchor="middle" class="text" font-weight="bold">External Validation</text>
  <text x="1290" y="1255" text-anchor="middle" class="text-small">CGI Payroll API</text>

  <!-- ARROWS: Delivery to External -->
  <line x1="200" y1="870" x2="190" y2="1220" class="arrow-dashed"/>
  <line x1="440" y1="870" x2="410" y2="1220" class="arrow-dashed"/>
  <line x1="440" y1="310" x2="630" y2="1220" class="arrow-dashed"/>
  <line x1="440" y1="310" x2="850" y2="1220" class="arrow-dashed"/>

  <!-- LEGEND -->
  <rect x="50" y="1320" width="1300" height="200" class="box" opacity="0.1"/>
  <text x="700" y="1345" text-anchor="middle" class="section-title">Legend &amp; Data Flow</text>
  
  <line x1="100" y1="1360" x2="150" y2="1360" class="arrow"/>
  <text x="160" y="1365" class="text">Solid Arrow: Direct call</text>
  
  <line x1="100" y1="1380" x2="150" y2="1380" class="arrow-dashed"/>
  <text x="160" y="1385" class="text">Dashed Arrow: Async/Event</text>
  
  <rect x="100" y="1400" width="30" height="20" class="scheduler-box"/>
  <text x="140" y="1415" class="text">Scheduler Component</text>
  
  <rect x="300" y="1400" width="30" height="20" class="controller-box"/>
  <text x="340" y="1415" class="text">REST Controller</text>
  
  <rect x="500" y="1400" width="30" height="20" class="service-box"/>
  <text x="540" y="1415" class="text">Service Layer</text>
  
  <rect x="700" y="1400" width="30" height="20" class="pipeline-box"/>
  <text x="740" y="1415" class="text">Pipeline Stage</text>
  
  <rect x="900" y="1400" width="30" height="20" class="database-box"/>
  <text x="940" y="1415" class="text">Database</text>
  
  <rect x="1100" y="1400" width="30" height="20" class="delivery-box"/>
  <text x="1140" y="1415" class="text">Delivery Service</text>

  <!-- FLOW DESCRIPTION -->
  <text x="100" y="1445" class="text" font-weight="bold">Typical Flow:</text>
  <text x="100" y="1465" class="text-small">1. User/System triggers report → BI Controller → Job Queue Service → Creates job in DB (QUEUED)</text>
  <text x="100" y="1480" class="text-small">2. Batch Job Scheduler polls DB every 5s → Finds QUEUED jobs → Claims job (PROCESSING) → Background Processing Service</text>
  <text x="100" y="1495" class="text-small">3. Background Processing → Report Generation Service → 5-Stage Pipeline → Chunked processing → File generation</text>
  <text x="100" y="1510" class="text-small">4. Report complete → Update job status (COMPLETED) → Delivery Service (Email/SFTP) → Notification Service</text>
  <text x="100" y="1525" class="text-small">5. Job Dependency Service checks for dependent jobs → Triggers dependent jobs if parent succeeded</text>

</svg>

