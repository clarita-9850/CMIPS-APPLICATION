<svg width="1800" height="2400" xmlns="http://www.w3.org/2000/svg">
  <!-- Title -->
  <text x="900" y="30" font-family="Arial, sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    CMIPS Logging &amp; Auditing Architecture
  </text>
  <text x="900" y="55" font-family="Arial, sans-serif" font-size="14" text-anchor="middle" fill="#666">
    Complete Audit Trail from Login to Every Action
  </text>
  
  <!-- AWS Cloud Container -->
  <rect x="50" y="80" width="1700" height="2280" fill="#f0f8ff" stroke="#1e3a8a" stroke-width="2" rx="10"/>
  
  <!-- Login Flow Section -->
  <text x="900" y="120" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    Step 1: User Login - Complete Audit Trail
  </text>
  
  <!-- Frontend Login -->
  <rect x="100" y="150" width="300" height="120" fill="#4a90e2" stroke="#1e3a8a" stroke-width="2" rx="5"/>
  <text x="250" y="175" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="white">
    Frontend (Next.js)
  </text>
  <text x="250" y="195" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">
    User Action: Login Attempt
  </text>
  <text x="250" y="215" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#333">
    Logs to Browser Console:
  </text>
  <text x="250" y="230" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#333">
    • Login attempt: username
  </text>
  <text x="250" y="245" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#333">
    • Timestamp: 2024-11-20T12:00:00Z
  </text>
  <text x="250" y="260" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#333">
    • IP Address: Client IP
  </text>
  
  <!-- Keycloak Login -->
  <rect x="450" y="150" width="400" height="200" fill="#ff6b6b" stroke="#c92a2a" stroke-width="2" rx="5"/>
  <text x="650" y="175" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="white">
    Keycloak Authentication
  </text>
  <text x="650" y="195" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">
    POST /realms/cmips/protocol/openid-connect/token
  </text>
  
  <!-- Keycloak Audit Logs -->
  <rect x="470" y="210" width="360" height="130" fill="#ffe0e0" stroke="#c92a2a" stroke-width="1" rx="3"/>
  <text x="650" y="230" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#c92a2a">
    Keycloak Audit Logs (EVENTS table)
  </text>
  <text x="480" y="250" font-family="Arial, sans-serif" font-size="9" fill="#333">
    Event Type: LOGIN
  </text>
  <text x="480" y="265" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • User ID: provider1
  </text>
  <text x="480" y="280" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Client ID: cmips-frontend
  </text>
  <text x="480" y="295" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • IP Address: 10.0.1.50
  </text>
  <text x="480" y="310" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Timestamp: 2024-11-20T12:00:01Z
  </text>
  <text x="480" y="325" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Result: SUCCESS / FAILURE
  </text>
  <text x="480" y="340" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Session ID: abc123-def456
  </text>
  
  <!-- Backend Logs -->
  <rect x="900" y="150" width="300" height="200" fill="#51cf66" stroke="#2b8a3e" stroke-width="2" rx="5"/>
  <text x="1050" y="175" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="white">
    Backend (Spring Boot)
  </text>
  <text x="1050" y="195" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">
    POST /api/auth/login
  </text>
  
  <rect x="920" y="210" width="260" height="130" fill="#e0f2e0" stroke="#2b8a3e" stroke-width="1" rx="3"/>
  <text x="1050" y="230" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#2b8a3e">
    Application Logs (SLF4J/Logback)
  </text>
  <text x="930" y="250" font-family="Arial, sans-serif" font-size="9" fill="#333">
    INFO: Login attempt for user: provider1
  </text>
  <text x="930" y="265" font-family="Arial, sans-serif" font-size="9" fill="#333">
    INFO: Keycloak token obtained
  </text>
  <text x="930" y="280" font-family="Arial, sans-serif" font-size="9" fill="#333">
    INFO: User roles: [PROVIDER]
  </text>
  <text x="930" y="295" font-family="Arial, sans-serif" font-size="9" fill="#333">
    INFO: Login successful: provider1
  </text>
  <text x="930" y="310" font-family="Arial, sans-serif" font-size="9" fill="#333">
    WARN: Failed login: username (if failed)
  </text>
  <text x="930" y="325" font-family="Arial, sans-serif" font-size="9" fill="#333">
    ERROR: Authentication error: ...
  </text>
  
  <!-- CloudWatch -->
  <rect x="1250" y="150" width="300" height="200" fill="#ffd43b" stroke="#f59f00" stroke-width="2" rx="5"/>
  <text x="1400" y="175" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#333">
    CloudWatch Logs
  </text>
  <text x="1400" y="195" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#333">
    Log Group: /aws/ecs/cmips-backend
  </text>
  
  <rect x="1270" y="210" width="260" height="130" fill="#fff9e0" stroke="#f59f00" stroke-width="1" rx="3"/>
  <text x="1400" y="230" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#f59f00">
    Aggregated Logs
  </text>
  <text x="1280" y="250" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • All application logs
  </text>
  <text x="1280" y="265" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Log retention: 30 days
  </text>
  <text x="1280" y="280" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Searchable &amp; filterable
  </text>
  <text x="1280" y="295" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Metric filters: ERROR, WARN
  </text>
  <text x="1280" y="310" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • CloudWatch Alarms
  </text>
  <text x="1280" y="325" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Log Insights queries
  </text>
  
  <!-- CloudTrail -->
  <rect x="1600" y="150" width="130" height="200" fill="#ff922b" stroke="#e67700" stroke-width="2" rx="5"/>
  <text x="1665" y="175" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="white">
    CloudTrail
  </text>
  <text x="1665" y="195" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">
    AWS API Calls
  </text>
  <text x="1665" y="220" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#333">
    • ECS API calls
  </text>
  <text x="1665" y="235" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#333">
    • RDS API calls
  </text>
  <text x="1665" y="250" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#333">
    • Secrets Manager
  </text>
  <text x="1665" y="265" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#333">
    • IAM changes
  </text>
  <text x="1665" y="280" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#333">
    • Who, What, When
  </text>
  <text x="1665" y="295" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#333">
    • IP Address
  </text>
  <text x="1665" y="310" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#333">
    • Request/Response
  </text>
  
  <!-- Step 2: API Actions -->
  <text x="900" y="400" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    Step 2: API Actions - Complete Audit Trail
  </text>
  
  <!-- Address Change Action -->
  <rect x="100" y="430" width="800" height="180" fill="#e3f2fd" stroke="#1976d2" stroke-width="2" rx="5"/>
  <text x="500" y="455" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#1976d2">
    Action: Provider Submits Address Change
  </text>
  <text x="500" y="475" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#333">
    POST /api/cases/address-change
  </text>
  
  <!-- What Gets Logged -->
  <rect x="120" y="490" width="760" height="110" fill="#e0f2f1" stroke="#00695c" stroke-width="1" rx="3"/>
  <text x="500" y="510" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#00695c">
    Logged Information:
  </text>
  <text x="140" y="530" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • User: provider1 | IP: 10.0.1.50 | Timestamp: 2024-11-20T12:05:00Z
  </text>
  <text x="140" y="545" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Request: POST /api/cases/address-change | Method: POST | Path: /api/cases/address-change
  </text>
  <text x="140" y="560" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Request Body: {caseId, recipientId, providerId, newAddress: {line1, city, state, zip}}
  </text>
  <text x="140" y="575" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Response: 200 OK | Response Time: 245ms | Status Code: 200
  </text>
  <text x="140" y="590" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Kafka Event Published: case.address.changed | Event ID: uuid-123
  </text>
  
  <!-- Keycloak Admin Actions -->
  <rect x="950" y="430" width="780" height="180" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="2" rx="5"/>
  <text x="1340" y="455" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#7b1fa2">
    Keycloak Admin Actions - What Gets Logged
  </text>
  
  <rect x="970" y="480" width="740" height="120" fill="#f0e0f5" stroke="#7b1fa2" stroke-width="1" rx="3"/>
  <text x="1340" y="500" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#7b1fa2">
    Keycloak Admin API Audit Events:
  </text>
  <text x="990" y="520" font-family="Arial, sans-serif" font-size="9" fill="#333">
    CREATE_USER: {userId, username, email, createdBy: admin, timestamp, IP address}
  </text>
  <text x="990" y="535" font-family="Arial, sans-serif" font-size="9" fill="#333">
    UPDATE_USER: {userId, changes: {attribute, oldValue, newValue}, updatedBy, timestamp}
  </text>
  <text x="990" y="550" font-family="Arial, sans-serif" font-size="9" fill="#333">
    DELETE_USER: {userId, deletedBy: admin, timestamp, reason}
  </text>
  <text x="990" y="565" font-family="Arial, sans-serif" font-size="9" fill="#333">
    ASSIGN_ROLE: {userId, roleName, assignedBy, timestamp}
  </text>
  <text x="990" y="580" font-family="Arial, sans-serif" font-size="9" fill="#333">
    REMOVE_ROLE: {userId, roleName, removedBy, timestamp}
  </text>
  <text x="990" y="595" font-family="Arial, sans-serif" font-size="9" fill="#333">
    RESET_PASSWORD: {userId, resetBy, timestamp, method: email/admin}
  </text>
  
  <!-- Step 3: Database Operations -->
  <text x="900" y="660" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    Step 3: Database Operations - Audit Trail
  </text>
  
  <!-- PostgreSQL Audit -->
  <rect x="100" y="690" width="800" height="200" fill="#339af0" stroke="#1c7ed6" stroke-width="2" rx="5"/>
  <text x="500" y="715" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    PostgreSQL Audit Logs (pgAudit Extension)
  </text>
  
  <rect x="120" y="740" width="760" height="140" fill="#e0f0ff" stroke="#1c7ed6" stroke-width="1" rx="3"/>
  <text x="500" y="760" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#1c7ed6">
    Database Query Logs:
  </text>
  <text x="140" y="780" font-family="Arial, sans-serif" font-size="9" fill="#333">
    INSERT INTO notifications (user_id, message, ...) VALUES ('recipient1', '...', ...)
  </text>
  <text x="140" y="795" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Logged: User: provider1 | Connection: 10.0.2.10:5432 | Timestamp: 2024-11-20T12:05:01Z
  </text>
  <text x="140" y="810" font-family="Arial, sans-serif" font-size="9" fill="#333">
    INSERT INTO tasks (title, work_queue, ...) VALUES ('Address Validation...', 'PROVIDER_MANAGEMENT', ...)
  </text>
  <text x="140" y="825" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Logged: User: system | Connection: 10.0.2.10:5432 | Timestamp: 2024-11-20T12:05:02Z
  </text>
  <text x="140" y="840" font-family="Arial, sans-serif" font-size="9" fill="#333">
    SELECT * FROM work_queue_subscriptions WHERE username = 'caseworker1'
  </text>
  <text x="140" y="855" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Logged: User: caseworker1 | Connection: 10.0.2.10:5432 | Timestamp: 2024-11-20T12:10:00Z
  </text>
  <text x="140" y="870" font-family="Arial, sans-serif" font-size="9" fill="#333">
    UPDATE tasks SET status = 'IN_PROGRESS' WHERE id = 123
  </text>
  <text x="140" y="885" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Logged: User: caseworker1 | Old Value: OPEN | New Value: IN_PROGRESS | Timestamp: 2024-11-20T12:15:00Z
  </text>
  
  <!-- Application-Level Audit -->
  <rect x="950" y="690" width="780" height="200" fill="#51cf66" stroke="#2b8a3e" stroke-width="2" rx="5"/>
  <text x="1340" y="715" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    Application-Level Audit Logs
  </text>
  
  <rect x="970" y="740" width="740" height="140" fill="#e0f2e0" stroke="#2b8a3e" stroke-width="1" rx="3"/>
  <text x="1340" y="760" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#2b8a3e">
    Business Logic Audit Events:
  </text>
  <text x="990" y="780" font-family="Arial, sans-serif" font-size="9" fill="#333">
    TASK_CREATED: {taskId: 123, title: 'Address Validation', workQueue: 'PROVIDER_MANAGEMENT', createdBy: 'system', timestamp}
  </text>
  <text x="990" y="795" font-family="Arial, sans-serif" font-size="9" fill="#333">
    TASK_ASSIGNED: {taskId: 123, assignedTo: 'caseworker1', assignedBy: 'supervisor1', timestamp}
  </text>
  <text x="990" y="810" font-family="Arial, sans-serif" font-size="9" fill="#333">
    TASK_STATUS_CHANGED: {taskId: 123, oldStatus: 'OPEN', newStatus: 'IN_PROGRESS', changedBy: 'caseworker1', timestamp}
  </text>
  <text x="990" y="825" font-family="Arial, sans-serif" font-size="9" fill="#333">
    QUEUE_SUBSCRIPTION_ADDED: {username: 'caseworker1', queue: 'PROVIDER_MANAGEMENT', subscribedBy: 'supervisor1', timestamp}
  </text>
  <text x="990" y="840" font-family="Arial, sans-serif" font-size="9" fill="#333">
    NOTIFICATION_CREATED: {notificationId: 456, userId: 'recipient1', type: 'INFO', createdBy: 'system', timestamp}
  </text>
  <text x="990" y="855" font-family="Arial, sans-serif" font-size="9" fill="#333">
    ADDRESS_CHANGE_SUBMITTED: {providerId: 'provider1', recipientId: 'recipient1', newState: 'NV', submittedBy: 'provider1', timestamp}
  </text>
  <text x="990" y="870" font-family="Arial, sans-serif" font-size="9" fill="#333">
    KAFKA_EVENT_PUBLISHED: {eventType: 'case.address.changed', eventId: 'uuid-123', publishedBy: 'system', timestamp}
  </text>
  
  <!-- Step 4: Keycloak Detailed Logs -->
  <text x="900" y="940" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    Step 4: Keycloak Detailed Audit Events
  </text>
  
  <!-- Keycloak Event Types -->
  <rect x="100" y="970" width="1630" height="300" fill="#ffebee" stroke="#c62828" stroke-width="2" rx="5"/>
  <text x="915" y="995" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#c62828">
    Keycloak Event Types &amp; What Gets Logged
  </text>
  
  <!-- Column 1 -->
  <rect x="120" y="1010" width="500" height="240" fill="#ffffff" stroke="#c62828" stroke-width="1" rx="3"/>
  <text x="370" y="1030" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#c62828">
    Authentication Events
  </text>
  <text x="140" y="1050" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">LOGIN:</text>
  <text x="140" y="1065" font-family="Arial, sans-serif" font-size="9" fill="#333">• userId, username, IP address</text>
  <text x="140" y="1078" font-family="Arial, sans-serif" font-size="9" fill="#333">• clientId, sessionId, timestamp</text>
  <text x="140" y="1091" font-family="Arial, sans-serif" font-size="9" fill="#333">• result: SUCCESS/FAILURE</text>
  <text x="140" y="1104" font-family="Arial, sans-serif" font-size="9" fill="#333">• error (if failed), userAgent</text>
  
  <text x="140" y="1125" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">LOGOUT:</text>
  <text x="140" y="1140" font-family="Arial, sans-serif" font-size="9" fill="#333">• userId, sessionId, timestamp</text>
  <text x="140" y="1153" font-family="Arial, sans-serif" font-size="9" fill="#333">• clientId, IP address</text>
  
  <text x="140" y="1174" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">LOGIN_ERROR:</text>
  <text x="140" y="1189" font-family="Arial, sans-serif" font-size="9" fill="#333">• username (attempted), error type</text>
  <text x="140" y="1202" font-family="Arial, sans-serif" font-size="9" fill="#333">• IP address, clientId, timestamp</text>
  <text x="140" y="1215" font-family="Arial, sans-serif" font-size="9" fill="#333">• error: invalid_credentials, user_not_found</text>
  
  <text x="140" y="1236" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">UPDATE_PASSWORD:</text>
  <text x="140" y="1251" font-family="Arial, sans-serif" font-size="9" fill="#333">• userId, timestamp, IP address</text>
  
  <!-- Column 2 -->
  <rect x="650" y="1010" width="500" height="240" fill="#ffffff" stroke="#c62828" stroke-width="1" rx="3"/>
  <text x="900" y="1030" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#c62828">
    User Management Events
  </text>
  <text x="670" y="1050" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">REGISTER:</text>
  <text x="670" y="1065" font-family="Arial, sans-serif" font-size="9" fill="#333">• userId, username, email, timestamp</text>
  <text x="670" y="1078" font-family="Arial, sans-serif" font-size="9" fill="#333">• IP address, clientId</text>
  
  <text x="670" y="1099" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">UPDATE_PROFILE:</text>
  <text x="670" y="1114" font-family="Arial, sans-serif" font-size="9" fill="#333">• userId, changes: {attribute, value}</text>
  <text x="670" y="1127" font-family="Arial, sans-serif" font-size="9" fill="#333">• timestamp, IP address</text>
  
  <text x="670" y="1148" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">UPDATE_EMAIL:</text>
  <text x="670" y="1163" font-family="Arial, sans-serif" font-size="9" fill="#333">• userId, oldEmail, newEmail</text>
  <text x="670" y="1176" font-family="Arial, sans-serif" font-size="9" fill="#333">• timestamp, IP address</text>
  
  <text x="670" y="1197" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">SEND_RESET_PASSWORD:</text>
  <text x="670" y="1212" font-family="Arial, sans-serif" font-size="9" fill="#333">• userId, email, timestamp</text>
  <text x="670" y="1225" font-family="Arial, sans-serif" font-size="9" fill="#333">• IP address, clientId</text>
  
  <text x="670" y="1246" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">VERIFY_EMAIL:</text>
  <text x="670" y="1261" font-family="Arial, sans-serif" font-size="9" fill="#333">• userId, timestamp, IP address</text>
  
  <!-- Column 3 -->
  <rect x="1180" y="1010" width="520" height="240" fill="#ffffff" stroke="#c62828" stroke-width="1" rx="3"/>
  <text x="1440" y="1030" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#c62828">
    Admin API Events (via Backend)
  </text>
  <text x="1200" y="1050" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">CREATE_USER:</text>
  <text x="1200" y="1065" font-family="Arial, sans-serif" font-size="9" fill="#333">• userId, username, email, createdBy: admin</text>
  <text x="1200" y="1078" font-family="Arial, sans-serif" font-size="9" fill="#333">• timestamp, IP address, attributes</text>
  
  <text x="1200" y="1099" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">UPDATE_USER:</text>
  <text x="1200" y="1114" font-family="Arial, sans-serif" font-size="9" fill="#333">• userId, changes: {field, oldValue, newValue}</text>
  <text x="1200" y="1127" font-family="Arial, sans-serif" font-size="9" fill="#333">• updatedBy: admin, timestamp</text>
  
  <text x="1200" y="1148" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">DELETE_USER:</text>
  <text x="1200" y="1163" font-family="Arial, sans-serif" font-size="9" fill="#333">• userId, deletedBy: admin, timestamp</text>
  <text x="1200" y="1176" font-family="Arial, sans-serif" font-size="9" fill="#333">• reason (if provided)</text>
  
  <text x="1200" y="1197" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">ASSIGN_ROLE:</text>
  <text x="1200" y="1212" font-family="Arial, sans-serif" font-size="9" fill="#333">• userId, roleName, assignedBy: admin</text>
  <text x="1200" y="1225" font-family="Arial, sans-serif" font-size="9" fill="#333">• timestamp, IP address</text>
  
  <text x="1200" y="1246" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">REMOVE_ROLE:</text>
  <text x="1200" y="1261" font-family="Arial, sans-serif" font-size="9" fill="#333">• userId, roleName, removedBy: admin, timestamp</text>
  
  <!-- Step 5: Log Aggregation -->
  <text x="900" y="1320" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    Step 5: Log Aggregation &amp; Analysis
  </text>
  
  <!-- CloudWatch Logs -->
  <rect x="100" y="1350" width="500" height="200" fill="#ffd43b" stroke="#f59f00" stroke-width="2" rx="5"/>
  <text x="350" y="1375" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#333">
    CloudWatch Logs
  </text>
  <text x="350" y="1395" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#333">
    Centralized Log Storage
  </text>
  
  <rect x="120" y="1410" width="460" height="130" fill="#fff9e0" stroke="#f59f00" stroke-width="1" rx="3"/>
  <text x="350" y="1430" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#f59f00">
    Log Groups:
  </text>
  <text x="140" y="1450" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • /aws/ecs/cmips-backend (Application logs)
  </text>
  <text x="140" y="1465" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • /aws/ecs/cmips-frontend (Frontend logs)
  </text>
  <text x="140" y="1480" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • /aws/rds/postgresql (Database logs)
  </text>
  <text x="140" y="1495" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • /aws/keycloak (Keycloak logs)
  </text>
  <text x="140" y="1510" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Retention: 30 days (configurable)
  </text>
  <text x="140" y="1525" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Metric Filters: ERROR, WARN, Login attempts
  </text>
  <text x="140" y="1540" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • CloudWatch Insights: Query logs with SQL-like syntax
  </text>
  
  <!-- CloudTrail -->
  <rect x="650" y="1350" width="500" height="200" fill="#ff922b" stroke="#e67700" stroke-width="2" rx="5"/>
  <text x="900" y="1375" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    CloudTrail
  </text>
  <text x="900" y="1395" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="white">
    AWS API Audit Trail
  </text>
  
  <rect x="670" y="1410" width="460" height="130" fill="#ffe0d0" stroke="#e67700" stroke-width="1" rx="3"/>
  <text x="900" y="1430" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#e67700">
    Tracked Events:
  </text>
  <text x="690" y="1450" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • ECS: CreateService, UpdateService, DeleteService
  </text>
  <text x="690" y="1465" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • RDS: CreateDBInstance, ModifyDBInstance, DeleteDBInstance
  </text>
  <text x="690" y="1480" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Secrets Manager: GetSecretValue, CreateSecret, UpdateSecret
  </text>
  <text x="690" y="1495" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • IAM: CreateUser, AttachRolePolicy, CreateRole
  </text>
  <text x="690" y="1510" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • S3: PutObject, GetObject, DeleteObject
  </text>
  <text x="690" y="1525" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Who: IAM user/role | What: API call | When: Timestamp | IP: Source IP
  </text>
  <text x="690" y="1540" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Retention: 90 days (configurable to S3 for longer retention)
  </text>
  
  <!-- VPC Flow Logs -->
  <rect x="1200" y="1350" width="530" height="200" fill="#339af0" stroke="#1c7ed6" stroke-width="2" rx="5"/>
  <text x="1465" y="1375" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    VPC Flow Logs
  </text>
  <text x="1465" y="1395" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="white">
    Network Traffic Audit
  </text>
  
  <rect x="1220" y="1410" width="490" height="130" fill="#e0f0ff" stroke="#1c7ed6" stroke-width="1" rx="3"/>
  <text x="1465" y="1430" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#1c7ed6">
    Network Flow Information:
  </text>
  <text x="1240" y="1450" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Source IP, Destination IP, Port
  </text>
  <text x="1240" y="1465" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Protocol (TCP, UDP), Bytes transferred
  </text>
  <text x="1240" y="1480" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Action: ACCEPT, REJECT
  </text>
  <text x="1240" y="1495" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Timestamp, VPC ID, Subnet ID
  </text>
  <text x="1240" y="1510" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Instance ID, Security Group
  </text>
  <text x="1240" y="1525" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Use Case: Detect unauthorized access, DDoS attacks
  </text>
  <text x="1240" y="1540" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Destination: CloudWatch Logs or S3
  </text>
  
  <!-- Step 6: Log Analysis & Alerts -->
  <text x="900" y="1600" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    Step 6: Log Analysis &amp; Security Alerts
  </text>
  
  <!-- CloudWatch Alarms -->
  <rect x="100" y="1630" width="500" height="180" fill="#ff6b6b" stroke="#c92a2a" stroke-width="2" rx="5"/>
  <text x="350" y="1655" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    CloudWatch Alarms
  </text>
  
  <rect x="120" y="1680" width="460" height="120" fill="#ffe0e0" stroke="#c92a2a" stroke-width="1" rx="3"/>
  <text x="350" y="1700" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#c92a2a">
    Monitored Metrics:
  </text>
  <text x="140" y="1720" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Failed Login Attempts &gt; 5 in 5 minutes → Alert
  </text>
  <text x="140" y="1735" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Error Rate &gt; 5% for 5 minutes → Alert
  </text>
  <text x="140" y="1750" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Unauthorized Access (403) &gt; 10 in 1 minute → Alert
  </text>
  <text x="140" y="1765" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Database Connection Failures &gt; 3 → Alert
  </text>
  <text x="140" y="1780" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • High Latency (p95 &gt; 2s) → Alert
  </text>
  <text x="140" y="1795" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Notification: SNS → Email, SMS, PagerDuty
  </text>
  
  <!-- Security Monitoring -->
  <rect x="650" y="1630" width="500" height="180" fill="#51cf66" stroke="#2b8a3e" stroke-width="2" rx="5"/>
  <text x="900" y="1655" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    Security Monitoring Dashboard
  </text>
  
  <rect x="670" y="1680" width="460" height="120" fill="#e0f2e0" stroke="#2b8a3e" stroke-width="1" rx="3"/>
  <text x="900" y="1700" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#2b8a3e">
    Real-Time Monitoring:
  </text>
  <text x="690" y="1720" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Active Sessions: Track all logged-in users
  </text>
  <text x="690" y="1735" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Failed Login Attempts: Username, IP, timestamp
  </text>
  <text x="690" y="1750" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Privilege Escalation: Role changes, admin actions
  </text>
  <text x="690" y="1765" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Data Access: Who accessed what data, when
  </text>
  <text x="690" y="1780" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Anomaly Detection: Unusual patterns, suspicious activity
  </text>
  <text x="690" y="1795" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Compliance Reports: Generate audit reports for compliance
  </text>
  
  <!-- Log Retention & Compliance -->
  <rect x="1200" y="1630" width="530" height="180" fill="#9c88ff" stroke="#6c5ce7" stroke-width="2" rx="5"/>
  <text x="1465" y="1655" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    Log Retention &amp; Compliance
  </text>
  
  <rect x="1220" y="1680" width="490" height="120" fill="#f0e8ff" stroke="#6c5ce7" stroke-width="1" rx="3"/>
  <text x="1465" y="1700" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#6c5ce7">
    Retention Policies:
  </text>
  <text x="1240" y="1720" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • CloudWatch Logs: 30 days (hot storage)
  </text>
  <text x="1240" y="1735" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • S3 Archive: 7 years (cold storage, compliance)
  </text>
  <text x="1240" y="1750" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • CloudTrail: 90 days (default), archive to S3
  </text>
  <text x="1240" y="1765" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Keycloak Events: 90 days (configurable)
  </text>
  <text x="1240" y="1780" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Database Audit: 1 year (pgAudit logs)
  </text>
  <text x="1240" y="1795" font-family="Arial, sans-serif" font-size="9" fill="#333">
    • Compliance: HIPAA, SOC 2, GDPR ready
  </text>
  
  <!-- Complete Audit Trail Example -->
  <text x="900" y="1860" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    Complete Audit Trail Example: Address Change Action
  </text>
  
  <rect x="100" y="1890" width="1630" height="420" fill="#ffffff" stroke="#1e3a8a" stroke-width="2" rx="5"/>
  <text x="915" y="1915" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#1e3a8a">
    End-to-End Audit Trail for Single Action
  </text>
  
  <rect x="120" y="1940" width="1590" height="360" fill="#f8f9fa" stroke="#1e3a8a" stroke-width="1" rx="3"/>
  <text x="120" y="1965" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1e3a8a">1. Frontend Log:</text>
  <text x="120" y="1980" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:00Z] User provider1 initiated address change | IP: 10.0.1.50 | Browser: Chrome 120.0</text>
  
  <text x="120" y="2005" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1e3a8a">2. Backend Application Log:</text>
  <text x="120" y="2020" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:01Z] INFO: POST /api/cases/address-change | User: provider1 | IP: 10.0.1.50 | Request ID: req-123</text>
  <text x="120" y="2035" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:01Z] INFO: JWT validated | User: provider1 | Roles: [PROVIDER] | Token expires: 2024-11-20T13:05:00Z</text>
  <text x="120" y="2050" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:01Z] INFO: Address change payload: {providerId: provider1, recipientId: recipient1, newState: NV}</text>
  
  <text x="120" y="2075" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1e3a8a">3. Database Audit Log (pgAudit):</text>
  <text x="120" y="2090" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:02Z] AUDIT: INSERT INTO notifications | User: provider1 | Connection: 10.0.2.10:5432</text>
  <text x="120" y="2105" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:02Z] AUDIT: INSERT INTO notifications | Values: {userId: recipient1, message: '...', type: INFO}</text>
  
  <text x="120" y="2130" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1e3a8a">4. Kafka Event Log:</text>
  <text x="120" y="2145" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:03Z] INFO: Published event to cmips-case-events | Event ID: uuid-123 | Type: case.address.changed</text>
  <text x="120" y="2160" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:03Z] INFO: Event payload: {providerId: provider1, isOutsideCA: true, newState: NV}</text>
  
  <text x="120" y="2185" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1e3a8a">5. Task Consumer Log:</text>
  <text x="120" y="2200" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:04Z] INFO: Received event: case.address.changed | Event ID: uuid-123 | Consumer: task-consumer-group</text>
  <text x="120" y="2215" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:04Z] INFO: Creating task | Title: Address Validation Required | Queue: PROVIDER_MANAGEMENT</text>
  
  <text x="120" y="2240" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1e3a8a">6. Database Audit Log (Task Creation):</text>
  <text x="120" y="2255" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:05Z] AUDIT: INSERT INTO tasks | User: system | Connection: 10.0.2.10:5432</text>
  <text x="120" y="2270" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:05Z] AUDIT: INSERT INTO tasks | Values: {id: 123, workQueue: PROVIDER_MANAGEMENT, status: OPEN}</text>
  
  <text x="120" y="2295" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1e3a8a">7. CloudTrail (AWS API):</text>
  <text x="120" y="2310" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:06Z] CloudTrail: SecretsManager.GetSecretValue | User: BackendExecutionRole | IP: 10.0.2.10</text>
  
  <text x="120" y="2335" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1e3a8a">8. VPC Flow Log:</text>
  <text x="120" y="2350" font-family="Arial, sans-serif" font-size="9" fill="#333">   [2024-11-20T12:05:01Z] VPC Flow: 10.0.1.50:54321 → 10.0.2.10:8081 | TCP | ACCEPT | 1024 bytes</text>
  
  <!-- Arrows -->
  <path d="M 250 270 L 650 270" stroke="#1976d2" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 1050 270 L 1400 270" stroke="#2e7d32" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 1400 270 L 1665 270" stroke="#f59f00" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <!-- Arrow marker definition -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333"/>
    </marker>
  </defs>
</svg>





