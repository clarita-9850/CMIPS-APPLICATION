<svg width="1200" height="1400" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font-family: Arial, sans-serif; font-size: 22px; font-weight: bold; fill: #1a1a1a; }
      .section-title { font-family: Arial, sans-serif; font-size: 16px; font-weight: bold; fill: #2c3e50; }
      .box { fill: #ecf0f1; stroke: #34495e; stroke-width: 2; rx: 5; }
      .scheduler-box { fill: #fff3e0; stroke: #e65100; stroke-width: 2; rx: 5; }
      .service-box { fill: #e8f5e9; stroke: #2e7d32; stroke-width: 2; rx: 5; }
      .database-box { fill: #f3e5f5; stroke: #6a1b9a; stroke-width: 2; rx: 5; }
      .keycloak-box { fill: #e0f2f1; stroke: #00695c; stroke-width: 2; rx: 5; }
      .controller-box { fill: #e3f2fd; stroke: #1565c0; stroke-width: 2; rx: 5; }
      .text { font-family: Arial, sans-serif; font-size: 12px; fill: #2c3e50; }
      .text-small { font-family: Arial, sans-serif; font-size: 10px; fill: #555; }
      .text-bold { font-family: Arial, sans-serif; font-size: 12px; font-weight: bold; fill: #2c3e50; }
      .arrow { stroke: #34495e; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-dashed { stroke: #7f8c8d; stroke-width: 1.5; fill: none; stroke-dasharray: 5,5; marker-end: url(#arrowhead); }
      .label { font-family: Arial, sans-serif; font-size: 10px; fill: #555; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#34495e" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="600" y="30" text-anchor="middle" class="title">Batch Jobs Architecture</text>
  <text x="600" y="50" text-anchor="middle" class="text-small">IHSS Pipeline - Job Scheduling &amp; Processing System</text>

  <!-- ENTRY POINTS -->
  <rect x="50" y="70" width="1100" height="100" class="controller-box" opacity="0.2"/>
  <text x="600" y="95" text-anchor="middle" class="section-title">Entry Points</text>
  
  <rect x="100" y="110" width="200" height="50" class="controller-box"/>
  <text x="200" y="130" text-anchor="middle" class="text-bold">BI Controller</text>
  <text x="200" y="145" text-anchor="middle" class="text-small">POST /api/bi/reports/generate</text>
  <text x="200" y="157" text-anchor="middle" class="text-small">Manual job creation</text>

  <rect x="350" y="110" width="200" height="50" class="scheduler-box"/>
  <text x="450" y="130" text-anchor="middle" class="text-bold">Scheduled Report Service</text>
  <text x="450" y="145" text-anchor="middle" class="text-small">Daily/Weekly/Monthly Cron</text>
  <text x="450" y="157" text-anchor="middle" class="text-small">@Scheduled annotations</text>

  <rect x="600" y="110" width="200" height="50" class="scheduler-box"/>
  <text x="700" y="130" text-anchor="middle" class="text-bold">System Scheduler</text>
  <text x="700" y="145" text-anchor="middle" class="text-small">County-specific reports</text>
  <text x="700" y="157" text-anchor="middle" class="text-small">Every 2 minutes (test)</text>

  <rect x="850" y="110" width="200" height="50" class="scheduler-box"/>
  <text x="950" y="130" text-anchor="middle" class="text-bold">Job Dependency Service</text>
  <text x="950" y="145" text-anchor="middle" class="text-small">Auto-triggers dependent jobs</text>
  <text x="950" y="157" text-anchor="middle" class="text-small">ON_SUCCESS condition</text>

  <!-- JOB QUEUE LAYER -->
  <rect x="50" y="190" width="1100" height="120" class="service-box" opacity="0.2"/>
  <text x="600" y="215" text-anchor="middle" class="section-title">Job Queue Management</text>
  
  <rect x="100" y="230" width="250" height="70" class="service-box"/>
  <text x="225" y="250" text-anchor="middle" class="text-bold">Job Queue Service</text>
  <text x="225" y="265" text-anchor="middle" class="text-small">queueReportJob(request, jwtToken)</text>
  <text x="225" y="277" text-anchor="middle" class="text-small">getJobStatus(jobId)</text>
  <text x="225" y="289" text-anchor="middle" class="text-small">markJobAsProcessing(jobId)</text>

  <rect x="400" y="230" width="250" height="70" class="service-box"/>
  <text x="525" y="250" text-anchor="middle" class="text-bold">Background Processing Service</text>
  <text x="525" y="265" text-anchor="middle" class="text-small">processJob(jobId) - Async</text>
  <text x="525" y="277" text-anchor="middle" class="text-small">Chunked data processing</text>
  <text x="525" y="289" text-anchor="middle" class="text-small">Streaming file generation</text>

  <rect x="700" y="230" width="250" height="70" class="service-box"/>
  <text x="825" y="250" text-anchor="middle" class="text-bold">Batch Job Scheduler</text>
  <text x="825" y="265" text-anchor="middle" class="text-small">@Scheduled(fixedDelay=5000ms)</text>
  <text x="825" y="277" text-anchor="middle" class="text-small">Polls QUEUED jobs</text>
  <text x="825" y="289" text-anchor="middle" class="text-small">max-jobs-per-poll: 3</text>

  <rect x="1000" y="230" width="100" height="70" class="service-box"/>
  <text x="1050" y="250" text-anchor="middle" class="text-bold">Thread Pool</text>
  <text x="1050" y="265" text-anchor="middle" class="text-small">Executor</text>
  <text x="1050" y="277" text-anchor="middle" class="text-small">worker-pool-size: 2</text>
  <text x="1050" y="289" text-anchor="middle" class="text-small">batch-worker-*</text>

  <!-- JOB STATES -->
  <rect x="50" y="330" width="1100" height="100" class="box" opacity="0.2"/>
  <text x="600" y="355" text-anchor="middle" class="section-title">Job Lifecycle States</text>
  
  <rect x="100" y="370" width="150" height="50" class="box"/>
  <text x="175" y="390" text-anchor="middle" class="text-bold">QUEUED</text>
  <text x="175" y="405" text-anchor="middle" class="text-small">Job created</text>
  <text x="175" y="417" text-anchor="middle" class="text-small">Waiting for worker</text>

  <rect x="300" y="370" width="150" height="50" class="box"/>
  <text x="375" y="390" text-anchor="middle" class="text-bold">PROCESSING</text>
  <text x="375" y="405" text-anchor="middle" class="text-small">Claimed by worker</text>
  <text x="375" y="417" text-anchor="middle" class="text-small">In progress</text>

  <rect x="500" y="370" width="150" height="50" class="box"/>
  <text x="575" y="390" text-anchor="middle" class="text-bold">COMPLETED</text>
  <text x="575" y="405" text-anchor="middle" class="text-small">Report generated</text>
  <text x="575" y="417" text-anchor="middle" class="text-small">File saved</text>

  <rect x="700" y="370" width="150" height="50" class="box"/>
  <text x="775" y="390" text-anchor="middle" class="text-bold">FAILED</text>
  <text x="775" y="405" text-anchor="middle" class="text-small">Error occurred</text>
  <text x="775" y="417" text-anchor="middle" class="text-small">Retry if possible</text>

  <rect x="900" y="370" width="150" height="50" class="box"/>
  <text x="975" y="390" text-anchor="middle" class="text-bold">CANCELLED</text>
  <text x="975" y="405" text-anchor="middle" class="text-small">User cancelled</text>
  <text x="975" y="417" text-anchor="middle" class="text-small">No retry</text>

  <!-- KEYCLOAK INTEGRATION -->
  <rect x="50" y="450" width="1100" height="100" class="keycloak-box" opacity="0.2"/>
  <text x="600" y="475" text-anchor="middle" class="section-title">Keycloak Integration (JWT Token Management)</text>
  
  <rect x="100" y="495" width="200" height="45" class="keycloak-box"/>
  <text x="200" y="510" text-anchor="middle" class="text-bold">Keycloak Server</text>
  <text x="200" y="525" text-anchor="middle" class="text-small">Service account credentials</text>
  <text x="200" y="537" text-anchor="middle" class="text-small">Role-based token exchange</text>

  <rect x="350" y="495" width="200" height="45" class="keycloak-box"/>
  <text x="450" y="510" text-anchor="middle" class="text-bold">Cron User Accounts</text>
  <text x="450" y="525" text-anchor="middle" class="text-small">cron_admin, cron_supervisor</text>
  <text x="450" y="537" text-anchor="middle" class="text-small">cron_case_worker_CT1-CT5</text>

  <rect x="600" y="495" width="200" height="45" class="keycloak-box"/>
  <text x="700" y="510" text-anchor="middle" class="text-bold">JWT Token Storage</text>
  <text x="700" y="525" text-anchor="middle" class="text-small">Stored with job entity</text>
  <text x="700" y="537" text-anchor="middle" class="text-small">Used for field masking</text>

  <rect x="850" y="495" width="200" height="45" class="keycloak-box"/>
  <text x="950" y="510" text-anchor="middle" class="text-bold">County Extraction</text>
  <text x="950" y="525" text-anchor="middle" class="text-small">Extract countyId from JWT</text>
  <text x="950" y="537" text-anchor="middle" class="text-small">Enforce county restrictions</text>

  <!-- DATABASE LAYER -->
  <rect x="50" y="570" width="1100" height="120" class="database-box" opacity="0.2"/>
  <text x="600" y="595" text-anchor="middle" class="section-title">Database Layer</text>
  
  <rect x="100" y="615" width="300" height="65" class="database-box"/>
  <text x="250" y="635" text-anchor="middle" class="text-bold">PostgreSQL Database</text>
  <text x="250" y="650" text-anchor="middle" class="text-small">report_jobs table</text>
  <text x="250" y="662" text-anchor="middle" class="text-small">Fields: job_id, status, progress, user_role, report_type</text>
  <text x="250" y="674" text-anchor="middle" class="text-small">jwt_token, parent_job_id, result_path</text>

  <rect x="450" y="615" width="250" height="65" class="database-box"/>
  <text x="575" y="635" text-anchor="middle" class="text-bold">Report Job Repository</text>
  <text x="575" y="650" text-anchor="middle" class="text-small">findTopQueuedJobs(maxJobs)</text>
  <text x="575" y="662" text-anchor="middle" class="text-small">findByJobId(jobId)</text>
  <text x="575" y="674" text-anchor="middle" class="text-small">findByStatus(status)</text>

  <rect x="750" y="615" width="250" height="65" class="database-box"/>
  <text x="875" y="635" text-anchor="middle" class="text-bold">Job Query Methods</text>
  <text x="875" y="650" text-anchor="middle" class="text-small">findQueuedJobsByPriority()</text>
  <text x="875" y="662" text-anchor="middle" class="text-small">findByUserRole(role)</text>
  <text x="875" y="674" text-anchor="middle" class="text-small">JPA/Hibernate queries</text>

  <!-- PROCESSING FLOW -->
  <rect x="50" y="710" width="1100" height="200" class="box" opacity="0.1"/>
  <text x="600" y="735" text-anchor="middle" class="section-title">Job Processing Flow</text>
  
  <!-- Step 1 -->
  <rect x="100" y="750" width="180" height="70" class="box"/>
  <text x="190" y="770" text-anchor="middle" class="text-bold">Step 1: Job Creation</text>
  <text x="190" y="785" text-anchor="middle" class="text-small">BI Controller receives request</text>
  <text x="190" y="797" text-anchor="middle" class="text-small">Extract JWT token</text>
  <text x="190" y="809" text-anchor="middle" class="text-small">Job Queue Service creates job</text>
  <text x="190" y="821" text-anchor="middle" class="text-small">Status: QUEUED</text>

  <!-- Step 2 -->
  <rect x="320" y="750" width="180" height="70" class="box"/>
  <text x="410" y="770" text-anchor="middle" class="text-bold">Step 2: Job Polling</text>
  <text x="410" y="785" text-anchor="middle" class="text-small">Batch Job Scheduler runs</text>
  <text x="410" y="797" text-anchor="middle" class="text-small">Every 5 seconds</text>
  <text x="410" y="809" text-anchor="middle" class="text-small">Finds QUEUED jobs</text>
  <text x="410" y="821" text-anchor="middle" class="text-small">Max 3 jobs per poll</text>

  <!-- Step 3 -->
  <rect x="540" y="750" width="180" height="70" class="box"/>
  <text x="630" y="770" text-anchor="middle" class="text-bold">Step 3: Job Claiming</text>
  <text x="630" y="785" text-anchor="middle" class="text-small">markJobAsProcessing()</text>
  <text x="630" y="797" text-anchor="middle" class="text-small">Status: PROCESSING</text>
  <text x="630" y="809" text-anchor="middle" class="text-small">Assign to worker thread</text>
  <text x="630" y="821" text-anchor="middle" class="text-small">Thread pool executor</text>

  <!-- Step 4 -->
  <rect x="760" y="750" width="180" height="70" class="box"/>
  <text x="850" y="770" text-anchor="middle" class="text-bold">Step 4: Background</text>
  <text x="850" y="785" text-anchor="middle" class="text-bold">Processing</text>
  <text x="850" y="797" text-anchor="middle" class="text-small">Background Processing Service</text>
  <text x="850" y="809" text-anchor="middle" class="text-small">Chunked data processing</text>
  <text x="850" y="821" text-anchor="middle" class="text-small">Progress updates</text>

  <!-- Step 5 -->
  <rect x="980" y="750" width="120" height="70" class="box"/>
  <text x="1040" y="770" text-anchor="middle" class="text-bold">Step 5:</text>
  <text x="1040" y="785" text-anchor="middle" class="text-bold">Completion</text>
  <text x="1040" y="797" text-anchor="middle" class="text-small">Status: COMPLETED</text>
  <text x="1040" y="809" text-anchor="middle" class="text-small">Result path saved</text>
  <text x="1040" y="821" text-anchor="middle" class="text-small">Trigger dependencies</text>

  <!-- ARROWS -->
  <line x1="200" y1="160" x2="225" y2="230" class="arrow"/>
  <text x="212" y="200" class="label">Creates job</text>
  
  <line x1="450" y1="160" x2="225" y2="230" class="arrow"/>
  <text x="337" y="200" class="label">Scheduled jobs</text>
  
  <line x1="700" y1="160" x2="225" y2="230" class="arrow"/>
  <text x="462" y="200" class="label">County reports</text>
  
  <line x1="950" y1="160" x2="525" y2="230" class="arrow-dashed"/>
  <text x="737" y="200" class="label">Triggers deps</text>
  
  <line x1="825" y1="300" x2="225" y2="230" class="arrow"/>
  <text x="525" y="270" class="label">Polls queue</text>
  
  <line x1="225" y1="300" x2="630" y2="300" class="arrow"/>
  <text x="427" y="295" class="label">Claims job</text>
  
  <line x1="630" y1="300" x2="850" y2="300" class="arrow"/>
  <text x="740" y="295" class="label">Processes</text>
  
  <line x1="850" y1="300" x2="1040" y2="300" class="arrow"/>
  <text x="945" y="295" class="label">Completes</text>
  
  <line x1="200" y1="540" x2="700" y2="540" class="arrow-dashed"/>
  <text x="450" y="535" class="label">JWT tokens</text>
  
  <line x1="700" y1="540" x2="525" y2="300" class="arrow-dashed"/>
  <text x="612" y="420" class="label">For masking</text>
  
  <line x1="225" y1="300" x2="250" y2="615" class="arrow"/>
  <line x1="575" y1="680" x2="825" y2="300" class="arrow"/>
  <line x1="575" y1="680" x2="525" y2="300" class="arrow"/>

  <!-- STATE TRANSITIONS -->
  <line x1="175" y1="420" x2="375" y2="420" class="arrow"/>
  <text x="275" y="415" class="label">Claimed</text>
  
  <line x1="375" y1="420" x2="575" y2="420" class="arrow"/>
  <text x="475" y="415" class="label">Success</text>
  
  <line x1="375" y1="420" x2="775" y2="420" class="arrow"/>
  <text x="575" y="415" class="label">Error</text>
  
  <line x1="375" y1="420" x2="975" y2="420" class="arrow-dashed"/>
  <text x="675" y="415" class="label">Cancelled</text>

  <!-- CONFIGURATION -->
  <rect x="50" y="930" width="1100" height="120" class="box" opacity="0.1"/>
  <text x="600" y="955" text-anchor="middle" class="section-title">Configuration Properties</text>
  
  <rect x="100" y="970" width="200" height="70" class="box"/>
  <text x="200" y="990" text-anchor="middle" class="text-bold">Batch Scheduler</text>
  <text x="200" y="1005" text-anchor="middle" class="text-small">interval-ms: 5000</text>
  <text x="200" y="1017" text-anchor="middle" class="text-small">max-jobs-per-poll: 3</text>
  <text x="200" y="1029" text-anchor="middle" class="text-small">worker-pool-size: 2</text>

  <rect x="350" y="970" width="200" height="70" class="box"/>
  <text x="450" y="990" text-anchor="middle" class="text-bold">Job Processing</text>
  <text x="450" y="1005" text-anchor="middle" class="text-small">chunk-size: 1000</text>
  <text x="450" y="1017" text-anchor="middle" class="text-small">min-chunk-size: 50</text>
  <text x="450" y="1029" text-anchor="middle" class="text-small">max-chunk-size: 5000</text>

  <rect x="600" y="970" width="200" height="70" class="box"/>
  <text x="700" y="990" text-anchor="middle" class="text-bold">Scheduled Reports</text>
  <text x="700" y="1005" text-anchor="middle" class="text-small">daily-cron: 0 30 5 * * ?</text>
  <text x="700" y="1017" text-anchor="middle" class="text-small">weekly-cron: 0 30 5 * * MON</text>
  <text x="700" y="1029" text-anchor="middle" class="text-small">monthly-cron: 0 30 5 1 * ?</text>

  <rect x="850" y="970" width="200" height="70" class="box"/>
  <text x="950" y="990" text-anchor="middle" class="text-bold">Job Dependencies</text>
  <text x="950" y="1005" text-anchor="middle" class="text-small">parent-report-type</text>
  <text x="950" y="1017" text-anchor="middle" class="text-small">dependent-report-type</text>
  <text x="950" y="1029" text-anchor="middle" class="text-small">condition: ON_SUCCESS</text>

  <!-- LEGEND -->
  <rect x="50" y="1070" width="1100" height="100" class="box" opacity="0.1"/>
  <text x="600" y="1095" text-anchor="middle" class="section-title">Key Features</text>
  
  <text x="100" y="1115" class="text-small">• Asynchronous Processing: Jobs run in background worker threads</text>
  <text x="100" y="1130" class="text-small">• Priority-based Queue: Higher priority jobs processed first</text>
  <text x="100" y="1145" class="text-small">• Chunked Processing: Large datasets processed in chunks (1000 records)</text>
  <text x="100" y="1160" class="text-small">• Progress Tracking: Real-time progress updates (0-100%)</text>
  
  <text x="600" y="1115" class="text-small">• JWT-based Security: All jobs require valid JWT tokens</text>
  <text x="600" y="1130" class="text-small">• County Filtering: Automatic county-based data filtering</text>
  <text x="600" y="1145" class="text-small">• Job Dependencies: Automatic triggering of dependent jobs</text>
  <text x="600" y="1160" class="text-small">• Retry Mechanism: Failed jobs can be retried (max 3 attempts)</text>

</svg>

