<svg width="1600" height="1400" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="adminGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#F59E0B;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#D97706;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="userGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#2563EB;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="keycloakGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#EF4444;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#DC2626;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="backendGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#10B981;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="dbGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#8B5CF6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#7C3AED;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/>
    </filter>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
    <marker id="arrowheadBlue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#3B82F6" />
    </marker>
    <marker id="arrowheadGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#10B981" />
    </marker>
    <marker id="arrowheadRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#EF4444" />
    </marker>
    <marker id="arrowheadPurple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#8B5CF6" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="800" y="30" font-family="Arial, sans-serif" font-size="28" font-weight="bold" text-anchor="middle" fill="#1E3A8A">
    Keycloak Password Reset Flow
  </text>
  <text x="800" y="55" font-family="Arial, sans-serif" font-size="16" text-anchor="middle" fill="#6B7280">
    Complete Flow: User Creation → First Login → Password Reset
  </text>
  
  <!-- Phase 1: Admin Creates User -->
  <rect x="50" y="80" width="1500" height="220" rx="10" fill="#FEF3C7" stroke="#F59E0B" stroke-width="2" filter="url(#shadow)"/>
  <text x="800" y="105" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#92400E">
    Phase 1: Admin Creates User in Keycloak
  </text>
  
  <!-- Admin Dashboard -->
  <rect x="100" y="130" width="280" height="150" rx="8" fill="url(#adminGrad)" stroke="#D97706" stroke-width="2"/>
  <text x="240" y="155" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Admin Dashboard</text>
  <text x="240" y="175" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#FEF3C7">(Keycloak Admin UI)</text>
  <rect x="120" y="185" width="240" height="85" rx="5" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="240" y="205" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Admin fills form:</text>
  <text x="240" y="225" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">• Username: newuser</text>
  <text x="240" y="240" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">• Email: user@cmips.com</text>
  <text x="240" y="255" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">• Temporary Password: TempPass123!</text>
  <text x="240" y="270" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">• Role: CASE_WORKER</text>
  
  <!-- Arrow 1 -->
  <path d="M 380 205 L 420 205" stroke="#F59E0B" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- Backend API -->
  <rect x="440" y="130" width="300" height="150" rx="8" fill="url(#backendGrad)" stroke="#059669" stroke-width="2"/>
  <text x="590" y="155" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Backend API</text>
  <text x="590" y="175" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#D1FAE5">POST /api/admin/keycloak/users</text>
  <rect x="460" y="185" width="260" height="85" rx="5" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="590" y="205" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">KeycloakAdminController</text>
  <text x="590" y="225" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">KeycloakAdminService.createUser()</text>
  <text x="590" y="245" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">Validates request &amp; calls Keycloak</text>
  <text x="590" y="260" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">Admin API</text>
  
  <!-- Arrow 2 -->
  <path d="M 740 205 L 780 205" stroke="#10B981" stroke-width="2" marker-end="url(#arrowheadGreen)"/>
  
  <!-- Keycloak Admin API -->
  <rect x="800" y="130" width="300" height="150" rx="8" fill="url(#keycloakGrad)" stroke="#DC2626" stroke-width="2"/>
  <text x="950" y="155" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Keycloak Admin API</text>
  <text x="950" y="175" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#FEE2E2">POST /admin/realms/cmips/users</text>
  <rect x="820" y="185" width="260" height="85" rx="5" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="950" y="205" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Creates user account</text>
  <text x="950" y="225" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Sets temporary password</text>
  <text x="950" y="245" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">Sets required action:</text>
  <text x="950" y="260" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">UPDATE_PASSWORD</text>
  
  <!-- Arrow 3 -->
  <path d="M 1100 205 L 1140 205" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowheadRed)"/>
  
  <!-- PostgreSQL Database -->
  <ellipse cx="1250" cy="205" rx="20" ry="10" fill="url(#dbGrad)" opacity="0.6"/>
  <rect x="1230" y="130" width="280" height="150" rx="8" fill="url(#dbGrad)" stroke="#7C3AED" stroke-width="2"/>
  <text x="1370" y="155" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">PostgreSQL</text>
  <text x="1370" y="175" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#E9D5FF">Keycloak Schema</text>
  <rect x="1250" y="185" width="240" height="85" rx="5" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="1370" y="205" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">user_entity table:</text>
  <text x="1370" y="225" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">• username: newuser</text>
  <text x="1370" y="240" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">• email: user@cmips.com</text>
  <text x="1370" y="255" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">• password_hash: [hashed]</text>
  <text x="1370" y="270" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">• required_action: UPDATE_PASSWORD</text>
  
  <!-- Phase 2: User First Login -->
  <rect x="50" y="340" width="1500" height="280" rx="10" fill="#DBEAFE" stroke="#3B82F6" stroke-width="2" filter="url(#shadow)"/>
  <text x="800" y="365" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#1E40AF">
    Phase 2: User First Login Attempt
  </text>
  
  <!-- User Browser -->
  <rect x="100" y="390" width="280" height="200" rx="8" fill="url(#userGrad)" stroke="#2563EB" stroke-width="2"/>
  <text x="240" y="415" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">User Browser</text>
  <text x="240" y="435" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#DBEAFE">Frontend Application</text>
  <rect x="120" y="445" width="240" height="135" rx="5" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="240" y="465" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Login Form:</text>
  <text x="240" y="485" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">• Username: newuser</text>
  <text x="240" y="500" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">• Password: TempPass123!</text>
  <text x="240" y="520" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">User clicks "Login"</text>
  <text x="240" y="540" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">AuthContext.login()</text>
  <text x="240" y="560" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">POST /api/auth/login</text>
  
  <!-- Arrow 4 -->
  <path d="M 380 490 L 420 490" stroke="#3B82F6" stroke-width="2" marker-end="url(#arrowheadBlue)"/>
  
  <!-- Backend Auth Controller -->
  <rect x="440" y="390" width="300" height="200" rx="8" fill="url(#backendGrad)" stroke="#059669" stroke-width="2"/>
  <text x="590" y="415" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Backend API</text>
  <text x="590" y="435" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#D1FAE5">AuthController.login()</text>
  <rect x="460" y="445" width="260" height="135" rx="5" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="590" y="465" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Receives login request</text>
  <text x="590" y="485" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">POST to Keycloak:</text>
  <text x="590" y="505" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">/realms/cmips/protocol/</text>
  <text x="590" y="520" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">openid-connect/token</text>
  <text x="590" y="540" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">grant_type=password</text>
  <text x="590" y="560" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">username + password</text>
  
  <!-- Arrow 5 -->
  <path d="M 740 490 L 780 490" stroke="#10B981" stroke-width="2" marker-end="url(#arrowheadGreen)"/>
  
  <!-- Keycloak Token Endpoint -->
  <rect x="800" y="390" width="300" height="200" rx="8" fill="url(#keycloakGrad)" stroke="#DC2626" stroke-width="2"/>
  <text x="950" y="415" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Keycloak</text>
  <text x="950" y="435" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#FEE2E2">Token Endpoint</text>
  <rect x="820" y="445" width="260" height="135" rx="5" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="950" y="465" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Validates credentials</text>
  <text x="950" y="485" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Checks user_entity table</text>
  <text x="950" y="505" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">Finds: required_action</text>
  <text x="950" y="520" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">= UPDATE_PASSWORD</text>
  <text x="950" y="540" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Returns JWT token</text>
  <text x="950" y="560" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">+ requiredActions array</text>
  
  <!-- Arrow 6 (Response) -->
  <path d="M 780 530 L 740 530" stroke="#EF4444" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowheadRed)"/>
  <text x="760" y="525" font-family="Arial, sans-serif" font-size="9" fill="#DC2626">JWT + requiredActions</text>
  
  <!-- Arrow 7 -->
  <path d="M 420 530 L 380 530" stroke="#3B82F6" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowheadBlue)"/>
  <text x="400" y="525" font-family="Arial, sans-serif" font-size="9" fill="#2563EB">Response</text>
  
  <!-- Frontend Response Handling -->
  <rect x="100" y="640" width="280" height="160" rx="8" fill="url(#userGrad)" stroke="#2563EB" stroke-width="2"/>
  <text x="240" y="665" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Frontend Response</text>
  <text x="240" y="685" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#DBEAFE">AuthContext.login()</text>
  <rect x="120" y="695" width="240" height="95" rx="5" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="240" y="715" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Decodes JWT token</text>
  <text x="240" y="735" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Checks requiredActions:</text>
  <text x="240" y="755" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">if (requiredActions.includes</text>
  <text x="240" y="770" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">('UPDATE_PASSWORD'))</text>
  <text x="240" y="785" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">→ Show Password Change Modal</text>
  
  <!-- Phase 3: Password Change Modal -->
  <rect x="50" y="840" width="1500" height="280" rx="10" fill="#F3E8FF" stroke="#8B5CF6" stroke-width="2" filter="url(#shadow)"/>
  <text x="800" y="865" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#7C3AED">
    Phase 3: Password Change Modal
  </text>
  
  <!-- Change Password Modal -->
  <rect x="100" y="890" width="400" height="200" rx="8" fill="#F3E8FF" stroke="#8B5CF6" stroke-width="2"/>
  <text x="300" y="915" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#7C3AED">ChangePasswordModal</text>
  <text x="300" y="935" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#6B21A8">(React Component)</text>
  <rect x="120" y="945" width="360" height="135" rx="5" fill="rgba(139,92,246,0.1)" stroke="#8B5CF6" stroke-width="1"/>
  <text x="300" y="965" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#6B21A8">Modal appears automatically</text>
  <text x="300" y="985" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#6B21A8">User cannot close modal</text>
  <text x="300" y="1005" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6B21A8">Form fields:</text>
  <text x="300" y="1020" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6B21A8">• Current Password</text>
  <text x="300" y="1035" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6B21A8">• New Password</text>
  <text x="300" y="1050" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6B21A8">• Confirm New Password</text>
  <text x="300" y="1065" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#6B21A8">User clicks "Change Password"</text>
  
  <!-- Arrow 8 -->
  <path d="M 500 990 L 540 990" stroke="#8B5CF6" stroke-width="2" marker-end="url(#arrowheadPurple)"/>
  
  <!-- Backend Password Change -->
  <rect x="560" y="890" width="300" height="200" rx="8" fill="url(#backendGrad)" stroke="#059669" stroke-width="2"/>
  <text x="710" y="915" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Backend API</text>
  <text x="710" y="935" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#D1FAE5">POST /api/auth/change-password</text>
  <rect x="580" y="945" width="260" height="135" rx="5" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="710" y="965" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">AuthController.changePassword()</text>
  <text x="710" y="985" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Validates JWT token</text>
  <text x="710" y="1005" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Extracts userId from token</text>
  <text x="710" y="1025" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">Validates current password</text>
  <text x="710" y="1045" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">Calls Keycloak Admin API</text>
  <text x="710" y="1065" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">to update password</text>
  
  <!-- Arrow 9 -->
  <path d="M 860 990 L 900 990" stroke="#10B981" stroke-width="2" marker-end="url(#arrowheadGreen)"/>
  
  <!-- Keycloak Admin API - Reset Password -->
  <rect x="920" y="890" width="300" height="200" rx="8" fill="url(#keycloakGrad)" stroke="#DC2626" stroke-width="2"/>
  <text x="1070" y="915" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Keycloak Admin API</text>
  <text x="1070" y="935" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#FEE2E2">PUT /admin/realms/cmips/users/{userId}/reset-password</text>
  <rect x="940" y="945" width="260" height="135" rx="5" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="1070" y="965" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Requires Admin Token</text>
  <text x="1070" y="985" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Request body:</text>
  <text x="1070" y="1005" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">{"type": "password",</text>
  <text x="1070" y="1020" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">"value": "NewPass123!",</text>
  <text x="1070" y="1035" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">"temporary": false}</text>
  <text x="1070" y="1055" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Updates password hash</text>
  <text x="1070" y="1070" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Removes UPDATE_PASSWORD action</text>
  
  <!-- Arrow 10 -->
  <path d="M 1220 990 L 1260 990" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowheadRed)"/>
  
  <!-- Database Update -->
  <ellipse cx="1310" cy="990" rx="20" ry="10" fill="url(#dbGrad)" opacity="0.6"/>
  <rect x="1290" y="890" width="240" height="200" rx="8" fill="url(#dbGrad)" stroke="#7C3AED" stroke-width="2"/>
  <text x="1410" y="915" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">PostgreSQL</text>
  <text x="1410" y="935" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#E9D5FF">Keycloak Schema</text>
  <rect x="1310" y="945" width="200" height="135" rx="5" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="1410" y="965" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Updates user_entity:</text>
  <text x="1410" y="985" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">• password_hash: [new hash]</text>
  <text x="1410" y="1000" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">• required_action: null</text>
  <text x="1410" y="1015" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">(removed)</text>
  <text x="1410" y="1035" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Password changed!</text>
  <text x="1410" y="1055" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">User can now login</text>
  <text x="1410" y="1070" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">normally</text>
  
  <!-- Phase 4: Success Response -->
  <rect x="50" y="1160" width="1500" height="200" rx="10" fill="#D1FAE5" stroke="#10B981" stroke-width="2" filter="url(#shadow)"/>
  <text x="800" y="1185" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#059669">
    Phase 4: Success Response &amp; User Access
  </text>
  
  <!-- Success Flow -->
  <rect x="100" y="1210" width="300" height="130" rx="8" fill="#D1FAE5" stroke="#10B981" stroke-width="2"/>
  <text x="250" y="1235" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#059669">Keycloak Response</text>
  <rect x="120" y="1245" width="260" height="85" rx="5" fill="rgba(16,185,129,0.1)" stroke="#10B981" stroke-width="1"/>
  <text x="250" y="1265" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#047857">Returns: 204 No Content</text>
  <text x="250" y="1285" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#047857">(Password updated successfully)</text>
  <text x="250" y="1305" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#047857">required_action removed</text>
  <text x="250" y="1320" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#047857">from user record</text>
  
  <!-- Arrow 11 -->
  <path d="M 400 1275 L 440 1275" stroke="#10B981" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowheadGreen)"/>
  
  <!-- Backend Success Response -->
  <rect x="460" y="1210" width="300" height="130" rx="8" fill="url(#backendGrad)" stroke="#059669" stroke-width="2"/>
  <text x="610" y="1235" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Backend Response</text>
  <rect x="480" y="1245" width="260" height="85" rx="5" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="610" y="1265" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">Returns JSON:</text>
  <text x="610" y="1285" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">{"success": true,</text>
  <text x="610" y="1305" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">"message": "Password changed"}</text>
  
  <!-- Arrow 12 -->
  <path d="M 760 1275 L 800 1275" stroke="#3B82F6" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowheadBlue)"/>
  
  <!-- Frontend Success Handling -->
  <rect x="820" y="1210" width="300" height="130" rx="8" fill="url(#userGrad)" stroke="#2563EB" stroke-width="2"/>
  <text x="970" y="1235" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Frontend Success</text>
  <rect x="840" y="1245" width="260" height="85" rx="5" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="970" y="1265" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">ChangePasswordModal</text>
  <text x="970" y="1285" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">onSuccess() callback</text>
  <text x="970" y="1305" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">Closes modal</text>
  <text x="970" y="1320" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">Redirects to dashboard</text>
  
  <!-- Arrow 13 -->
  <path d="M 1120 1275 L 1160 1275" stroke="#3B82F6" stroke-width="2" marker-end="url(#arrowheadBlue)"/>
  
  <!-- User Dashboard Access -->
  <rect x="1200" y="1210" width="300" height="130" rx="8" fill="#E0F2FE" stroke="#0EA5E9" stroke-width="2"/>
  <text x="1350" y="1235" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#0C4A6E">User Dashboard</text>
  <rect x="1220" y="1245" width="260" height="85" rx="5" fill="rgba(14,165,233,0.1)" stroke="#0EA5E9" stroke-width="1"/>
  <text x="1350" y="1265" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#075985">User can now access</text>
  <text x="1350" y="1285" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#075985">dashboard normally</text>
  <text x="1350" y="1305" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#075985">No password change</text>
  <text x="1350" y="1320" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#075985">required on next login</text>
  
  <!-- Summary Box -->
  <rect x="50" y="1400" width="1500" height="180" rx="10" fill="#F9FAFB" stroke="#6B7280" stroke-width="2"/>
  <text x="800" y="1425" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#374151">Key Points</text>
  
  <text x="100" y="1455" font-family="Arial, sans-serif" font-size="11" fill="#374151">1. Admin creates user with temporary password → Keycloak sets required_action: UPDATE_PASSWORD</text>
  <text x="100" y="1475" font-family="Arial, sans-serif" font-size="11" fill="#374151">2. User logs in with temporary password → Keycloak returns JWT + requiredActions array</text>
  <text x="100" y="1495" font-family="Arial, sans-serif" font-size="11" fill="#374151">3. Frontend detects UPDATE_PASSWORD in requiredActions → Shows password change modal (cannot be closed)</text>
  <text x="100" y="1515" font-family="Arial, sans-serif" font-size="11" fill="#374151">4. User enters new password → Frontend calls POST /api/auth/change-password → Backend calls Keycloak Admin API</text>
  <text x="100" y="1535" font-family="Arial, sans-serif" font-size="11" fill="#374151">5. Keycloak updates password hash and removes UPDATE_PASSWORD action → User can now login normally</text>
  <text x="100" y="1555" font-family="Arial, sans-serif" font-size="11" fill="#374151">6. Next login: No password change required → User goes directly to dashboard</text>
  
</svg>

